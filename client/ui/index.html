<!DOCTYPE html>
<!--
  DrakaShield Anti-Cheat – Pannello di controllo completo

  Questa pagina replica l'interfaccia vista nelle schermate inviate. È strutturata
  con una barra laterale per la navigazione e varie sezioni per dashboard,
  giocatori, ban, configurazione, ricerca, amministratori, protocolli e console.
  Tutti i testi sono in italiano e l'interfaccia non contiene riferimenti a
  WaveShield o Demo. Il design usa un tema scuro simile agli screenshot.

  Nota: questa è una interfaccia statica. Per renderla dinamica occorre
  collegare le sezioni a script lato server o client che forniscano i dati.
-->
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DrakaShield Anti‑Cheat</title>
    <style>
      /* ============= GLOBAL / LAYOUT RESTORE (lost in last merge) ============= */
      body {
        margin: 0;
        font-family: "Segoe UI", Arial, sans-serif;
        background: radial-gradient(circle at 25% 15%, #101a33 0%, #060b18 60%, #04070f 100%);
        color: #cdd6f4;
        display: flex;
        height: 100vh;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
      }
      * { box-sizing: border-box; }
      h1,h2,h3,h4 { font-weight: 600; letter-spacing: .5px; }
      a { color: #7aa2f7; text-decoration: none; }

      /* Scrollbar subtle */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #0b1122; }
      ::-webkit-scrollbar-thumb { background: #1e253f; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #2b3553; }

      /* Sidebar */
      #sidebar {
        width: 250px;
        background: linear-gradient(180deg,#0f1424 0%,#0a0f1d 60%,#070b14 100%);
        border-right: 1px solid #1e253f;
        padding: 18px 18px 14px 18px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        overflow-y: auto;
      }
      #sidebar h1 {
        margin: 0 0 4px 0;
        font-size: 18px;
        background: linear-gradient(90deg,#7aa2f7,#a0c5ff);
  background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        font-weight: 600;
      }
      #sidebar .section-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        color: #5e6b87;
        margin: 14px 0 4px 2px;
        font-weight: 600;
      }
      #sidebar ul { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 4px; }
      #sidebar ul li {
        font-size: 13px;
        padding: 10px 12px 10px 38px;
        background: #10172b;
        border: 1px solid #1a2238;
        border-radius: 8px;
        color: #9da9c2;
        cursor: pointer;
        position: relative;
        transition: background .18s, color .18s, border-color .18s;
        user-select: none;
      }
      #sidebar ul li:before {
        content: '';
        position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
        width: 14px; height: 14px; border-radius: 4px;
        background: linear-gradient(180deg,#202f52,#111a2e);
        border: 1px solid #2d3b5e;
      }
      #sidebar ul li:hover { background: #18223a; color: #cdd6f4; }
      #sidebar ul li.active {
        background: linear-gradient(90deg,#1d2c4d,#152036);
        border-color: #2b3a5e;
        color: #7aa2f7;
        box-shadow: 0 0 0 1px #2d4f8d inset, 0 2px 4px -2px rgba(0,0,0,.4);
      }
      #sidebar ul li.active:before { background: linear-gradient(180deg,#3d6ac1,#244170); border-color:#3d6ac1; }
      #sidebar .bottom { margin-top: auto; font-size: 11px; display: flex; flex-direction: column; gap: 6px; color: #5d6b86; }
      #sidebar .bottom div { cursor: pointer; }
      #sidebar .bottom div:hover { color: #7aa2f7; }

      /* Generic buttons */
      button:not(.period-btn):not(.log-chip) {
        font-family: inherit;
      }
      .btn, .button-primary {
        background: #1b263f;
        color: #cdd6f4;
        border: 1px solid #263552;
        border-radius: 8px;
        padding: 8px 14px;
        font-size: 13px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: background .18s, border-color .18s, color .18s, transform .15s;
      }
      .btn:hover, .button-primary:hover { background:#243455; }
      .btn:active, .button-primary:active { transform: translateY(1px); }
      .btn-danger { background:#2e1620; border-color:#46202e; color:#f7768e; }
      .btn-danger:hover { background:#3d1d2b; }
      .btn-secondary { background:#141d31; border-color:#1e2a45; color:#b4c1da; }
      .btn-secondary:hover { background:#1d2a45; }

      /* Category / chip active state unify */
      .chip-active, .log-chip.active { box-shadow: 0 0 0 1px #2d4f8d inset; }

      #main {
        flex: 1;
        background: #0a0d1e;
        overflow-y: auto;
        padding: 20px;
      }
      .section {
        display: none;
      }
      .section.active {
        display: block;
      }
      /* Dashboard cards */
      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
      }
      .card {
        background: #11152a;
        border: 1px solid #1e253f;
        border-radius: 10px;
        padding: 16px;
      }
      .card h3 {
        font-size: 14px;
        font-weight: normal;
        color: #7986a8;
        margin-bottom: 4px;
      }
      .card .value {
        font-size: 28px;
        font-weight: bold;
        color: #7aa2f7;
      }
      .card small {
        font-size: 12px;
        color: #7986a8;
      }
      /* Players grid */
      .players-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }
      .player-card {
        background: #11152a;
        border-radius: 10px;
        padding: 14px;
        border: 1px solid #1e253f;
        display: flex;
        flex-direction: column;
      }
      .player-card .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .player-card .id {
        font-size: 12px;
        background: #313b66;
        color: #cdd6f4;
        padding: 2px 6px;
        border-radius: 4px;
      }
      .player-card .ping {
        font-size: 12px;
        color: #a6adc8;
      }
      .player-card .name {
        font-weight: bold;
        color: #cdd6f4;
        margin-bottom: 4px;
      }
      .player-card .joined {
        font-size: 12px;
        color: #7986a8;
        margin-bottom: 8px;
      }
      .player-card .bar {
        height: 6px;
        background: #313b66;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 4px;
      }
      .player-card .bar div {
        height: 100%;
        background: #7aa2f7;
      }
      .player-card .bar.health div {
        background: #f7768e;
      }
      /* Tables */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      th, td {
        padding: 8px;
        border: 1px solid #1e253f;
        font-size: 13px;
      }
      th {
        background: #11152a;
        color: #7986a8;
        font-weight: normal;
      }
      tr:nth-child(even) td {
        background: #0d1330;
      }
      /* Toggle switches */
      .toggle {
        position: relative;
        width: 40px;
        height: 20px;
        display: inline-block;
      }
      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #1e253f;
        transition: .4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #7aa2f7;
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }
      /* Search bar */
      .search-bar {
        background: #11152a;
        border: 1px solid #1e253f;
        border-radius: 6px;
        padding: 6px 10px;
        margin-bottom: 10px;
        width: 100%;
        color: #cdd6f4;
      }
      /* Logs console */
      .console {
        background: #0d1330;
        border: 1px solid #1e253f;
        border-radius: 6px;
        padding: 10px;
        height: 400px;
        overflow-y: auto;
        font-family: monospace;
        white-space: pre;
        font-size: 12px;
      }
      /* Analysis redesigned card */
      .analysis-card {
        background:#0d1324;
        border:1px solid #1e253f;
        border-radius:10px;
        padding:18px 18px 14px;
        margin-top:20px;
        position:relative;
        display:flex;
        flex-direction:column;
        gap:14px;
      }
      .analysis-header {display:flex;align-items:flex-start;gap:18px;flex-wrap:wrap;}
      .analysis-title {font-size:16px;font-weight:600;color:#cdd6f4;}
      .analysis-sub {font-size:12px;color:#7986a8;margin-top:2px;}
      .analysis-metrics {display:flex;flex-wrap:wrap;gap:34px;margin-left:auto;}
      .analysis-metric {min-width:120px;}
      .analysis-metric h4 {font-size:11px;font-weight:500;letter-spacing:.5px;text-transform:uppercase;color:#6e7d99;margin-bottom:4px;}
      .analysis-metric .num {font-size:26px;font-weight:600;line-height:1;color:#7aa2f7;}
      .analysis-metric small {font-size:11px;color:#48526b;display:block;margin-top:4px;}
      .analysis-periods {position:absolute;top:14px;right:14px;display:flex;gap:4px;background:#0a1020;padding:4px 6px;border:1px solid #1e253f;border-radius:999px;}
      .analysis-periods button {background:transparent;border:none;color:#6e7d99;font-size:11px;padding:6px 10px;border-radius:999px;cursor:pointer;transition:background .15s,color .15s;}
      .analysis-periods button.active {background:#132341;color:#cdd6f4;}
      .analysis-chart-wrapper {position:relative;width:100%;height:200px;}
      #analysisChart {width:100%!important;height:100%!important;}
      .analysis-legend {display:flex;gap:18px;font-size:11px;color:#6e7d99;margin-top:4px;}
      .analysis-legend span {display:flex;align-items:center;gap:6px;}
      .dot {width:10px;height:10px;border-radius:2px;display:inline-block;}
      .dot.players {background:linear-gradient(180deg,#3a81f6,#1d3160);} 
      .dot.bans {background:linear-gradient(180deg,#f7768e,#6a1c29);} 
      .btn-export {position:absolute;bottom:14px;right:14px;background:#132341;color:#cdd6f4;border:1px solid #1e253f;font-size:11px;padding:6px 10px;border-radius:6px;cursor:pointer;}
      @media (max-width:900px){.analysis-metrics{gap:20px;margin-left:0;} .analysis-periods{position:static;margin-left:auto;} .analysis-card{padding-top:54px;}}
      /* Misc */
      h2 {
        margin-bottom: 12px;
        color: #cdd6f4;
        font-size: 20px;
      }
      h3 {
        margin-bottom: 8px;
        color: #cdd6f4;
        font-size: 16px;
      }

      /* Filters for players and logs */
      .filters {
        margin-bottom: 10px;
      }
      .filter-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 8px;
      }
      .filters label {
        font-size: 12px;
        color: #a6adc8;
      }
      .filters select {
        background: #11152a;
        border: 1px solid #1e253f;
        border-radius: 6px;
        padding: 4px;
        color: #cdd6f4;
        font-size: 12px;
      }

      /* Ban controls */
      .ban-controls {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .ban-controls button {
        background: #313b66;
        border: none;
        color: #cdd6f4;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
      }
      .ban-controls select {
        margin-left: auto;
        background: #11152a;
        border: 1px solid #1e253f;
        border-radius: 6px;
        color: #cdd6f4;
        padding: 4px 6px;
        font-size: 12px;
      }

      /* Config tabs */
      .config-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .config-tabs button {
        background: #11152a;
        border: 1px solid #1e253f;
        color: #cdd6f4;
        padding: 4px 8px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
      }
      .config-tabs button.active {
        background: #313b66;
        color: #7aa2f7;
      }

      /* Console controls */
      .console-controls {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }
      .console-controls button {
        background: #313b66;
        border: none;
        color: #cdd6f4;
        padding: 4px 8px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
      }
      .console-controls input {
        flex: 1;
        background: #11152a;
        border: 1px solid #1e253f;
        border-radius: 6px;
        padding: 6px;
        color: #cdd6f4;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div id="sidebar">
      <h1>DrakaShield Anti‑Cheat</h1>
      <div class="section-title">Server</div>
      <ul id="server-list">
        <li class="active" id="serverEntry" data-section="dashboard">Server</li>
      </ul>
      <div class="section-title">Navigazione</div>
      <ul id="nav-list">
        <li class="active" data-section="dashboard">Dashboard</li>
        <li data-section="players">Giocatori</li>
        <!-- <li data-section="map">Mappa interattiva</li> --> <!-- removed mappa interattiva -->
        <li data-section="multi">Multi Stream</li>
        <li data-section="bans">Bann</li>
        <li data-section="config">Configurazione</li>
        <li data-section="search">Ricerca</li>
        <li data-section="admins">Admins</li>
        <li data-section="logs">Protocolli</li>
        <li data-section="console">Console</li>
      </ul>
      <div class="bottom">
        <div>Supporto</div>
        <div>Documentazione</div>
      </div>
    </div>
    <!-- Main content -->
    <div id="main">
      <!-- Dashboard -->
      <div id="dashboard" class="section active">
        <h2>Dashboard server</h2>
        <div class="cards">
          <div class="card">
            <h3>Stato server</h3>
            <div class="value" id="cardServerStatus">...</div>
            <small id="cardServerName">...</small>
          </div>
          <div class="card">
            <h3>IP server</h3>
            <div class="value" id="cardServerIP">...</div>
            <small id="cardServerPlayers">Slot</small>
          </div>
          <div class="card">
            <h3>Licenza</h3>
            <div class="value" id="cardLicenseMasked">••••</div>
            <small id="cardLicenseStatus">...</small>
          </div>
          <div class="card">
            <h3>Scadenza</h3>
            <div class="value" id="cardLicenseDays">...</div>
            <small id="cardLicenseExpiry">...</small>
          </div>
        </div>
        <h3 style="margin-top:20px;">Analisi del server</h3>
        <div class="cards">
          <div class="card">
            <h3>Giocatori attuali</h3>
            <div class="value" id="cardPlayersNow">0</div>
            <small id="cardPlayersSlots">...</small>
          </div>
          <div class="card">
            <h3>Giocatori bannati</h3>
            <div class="value" id="cardPlayersBanned">0</div>
            <small>Ban attivi</small>
          </div>
          <div class="card">
            <h3>Picco giocatori</h3>
            <div class="value" id="cardPlayersPeak">0</div>
            <small>Sessione corrente</small>
          </div>
          <div class="card">
            <h3>Media giocatori</h3>
            <div class="value" id="cardPlayersAvg">0</div>
            <small>Sessione corrente</small>
          </div>
        </div>
        <div class="analysis-card" id="analysisCard">
          <div class="analysis-periods">
            <button class="period-btn active" data-period="today">Oggi</button>
            <button class="period-btn" data-period="7d">Ultimi 7 giorni</button>
            <button class="period-btn" data-period="30d">Ultimi 30 giorni</button>
          </div>
          <div class="analysis-header">
            <div>
              <div class="analysis-title">Analisi Server</div>
              <div class="analysis-sub">Statistiche giocatori e metriche prestazioni</div>
            </div>
            <div class="analysis-metrics">
              <div class="analysis-metric">
                <h4>Giocatori attuali</h4>
                <div class="num" id="analysisCurrentPlayers">0</div>
                <small id="analysisCurrentPlayersSlots">0 / 0</small>
              </div>
              <div class="analysis-metric">
                <h4>Giocatori bannati</h4>
                <div class="num" id="analysisBannedPlayers">0</div>
                <small>Totale cumulativo</small>
              </div>
              <div class="analysis-metric">
                <h4>Picco giocatori</h4>
                <div class="num" id="analysisPeakPlayers">0</div>
                <small id="analysisPeakLabel">(periodo)</small>
              </div>
              <div class="analysis-metric">
                <h4>Media giocatori</h4>
                <div class="num" id="analysisAvgPlayers">0</div>
                <small id="analysisAvgLabel">(periodo)</small>
              </div>
            </div>
          </div>
          <div class="analysis-chart-wrapper">
            <canvas id="analysisChart"></canvas>
          </div>
          <div class="analysis-legend">
            <span><span class="dot players"></span> Giocatori</span>
            <span><span class="dot bans"></span> Ban</span>
          </div>
          <button class="btn-export" id="exportSamples">Export CSV</button>
        </div>
        <button id="closeDashboard" style="margin-top:18px;background:#313b66;border:1px solid #1e253f;color:#cdd6f4;padding:8px 14px;border-radius:6px;cursor:pointer;">Chiudi Dashboard (ESC)</button>
      </div>
      <!-- Players -->
      <div id="players" class="section">
        <h2>Giocatori online</h2>
        <!-- Barra di ricerca per i giocatori -->
        <input id="playersSearch" class="search-bar" type="text" placeholder="Cerca giocatore per nome, ID o dettagli…" />
        <!-- Filtri per i giocatori -->
        <div class="filters">
          <label><input type="checkbox" id="filterNew"> Mostra nuovi giocatori (&lt;1h)</label>
          <label><input type="checkbox" id="filterRecent"> Mostra giocatori recenti (&lt;30m)</label>
          <label><input type="checkbox" id="filterThreat"> Mostra minacce potenziali</label>
        </div>
        <!-- Contenitore dinamico per i giocatori -->
        <div class="players-grid" id="playersContainer" style="margin-top:10px;"></div>
        <!-- Modale dettagli giocatore -->
        <div id="playerDetailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding-top:60px;z-index:500;">
          <div style="background:#0d1324;border:1px solid #1e253f;border-radius:14px;width:640px;max-width:95%;padding:26px 28px 24px;position:relative;font-size:14px;">
            <button id="closePlayerDetail" style="position:absolute;top:10px;right:10px;background:#132341;color:#cdd6f4;border:1px solid #1e253f;border-radius:6px;font-size:12px;padding:4px 8px;cursor:pointer;">✕</button>
            <h3 id="pdTitle" style="margin:0 0 4px 0;font-size:18px;color:#cdd6f4;display:flex;align-items:center;gap:8px;">
              <span style="font-size:18px;">👁️</span> <span id="pdName">Giocatore</span>
            </h3>
            <p style="margin:0 0 18px 0;color:#7986a8;font-size:12px;">Dettagli e azioni amministrative per questo giocatore</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:22px;">
              <div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Nome giocatore</div>
                <div id="pdNameVal" style="font-weight:600;margin-bottom:12px;">-</div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Stato</div>
                <div id="pdStatus" style="font-weight:600;margin-bottom:12px;">-</div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Tempo di gioco totale</div>
                <div id="pdPlayTotal" style="margin-bottom:12px;">-</div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Indirizzo IP</div>
                <div id="pdIP" style="margin-bottom:12px;">-</div>
              </div>
              <div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">ID giocatore</div>
                <div id="pdId" style="font-weight:600;margin-bottom:12px;">-</div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Tempo online</div>
                <div id="pdOnlineTime" style="margin-bottom:12px;">-</div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Affidabilità</div>
                <div id="pdReliability" style="display:flex;align-items:center;gap:6px;">-</div>
              </div>
            </div>
            <div style="background:#0a1020;border:1px solid #1e253f;border-radius:10px;padding:14px 16px;margin-bottom:22px;">
              <div style="font-size:12px;color:#7986a8;margin-bottom:8px;">Hai bisogno di maggiori dettagli su questo giocatore?</div>
              <button id="pdOpenSearch" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;font-size:12px;padding:6px 12px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:6px;">🔍 Apri nella ricerca giocatori</button>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <button id="btnKick" style="background:#141b2f;border:1px solid #1e253f;color:#cdd6f4;padding:10px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:6px;justify-content:center;">⏲️ Espelli giocatore</button>
              <button id="btnBan" style="background:#24131e;border:1px solid #3a1d29;color:#f7768e;padding:10px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:6px;justify-content:center;">⚡ Banna giocatore</button>
              <button id="btnScreenshot" style="background:#141b2f;border:1px solid #1e253f;color:#cdd6f4;padding:10px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:6px;justify-content:center;">📸 Screenshot</button>
              <button id="btnSpectate" style="background:#141b2f;border:1px solid #1e253f;color:#cdd6f4;padding:10px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:6px;justify-content:center;">🛰️ Osserva giocatore</button>
            </div>
            <div id="pdFeedback" style="margin-top:16px;font-size:12px;color:#7986a8;min-height:16px;"></div>
          </div>
        </div>
        <!-- Modale Kick -->
        <div id="kickModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding-top:120px;z-index:520;">
          <div style="background:#0d1324;border:1px solid #1e253f;border-radius:14px;width:560px;max-width:95%;padding:24px 26px 22px;position:relative;">
            <button data-close="kickModal" style="position:absolute;top:10px;right:10px;background:#132341;color:#cdd6f4;border:1px solid #1e253f;border-radius:6px;font-size:12px;padding:4px 8px;cursor:pointer;">✕</button>
            <h3 style="margin:0 0 4px 0;font-size:18px;color:#cdd6f4;display:flex;gap:8px;align-items:center;">🚫 <span id="kickTitle">Espelli</span></h3>
            <p style="margin:0 0 14px 0;color:#7986a8;font-size:12px;">Questa azione rimuove temporaneamente il giocatore dal server.</p>
            <label style="font-size:12px;color:#6e7d99;display:block;margin-bottom:6px;">Motivo kick (opzionale)</label>
            <textarea id="kickReason" style="width:100%;height:90px;background:#0a1020;border:1px solid #1e253f;border-radius:8px;padding:10px;color:#cdd6f4;resize:none;font-size:13px;" placeholder="Inserisci il motivo del kick..."></textarea>
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px;">
              <button data-close="kickModal" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;">Annulla</button>
              <button id="kickConfirm" style="background:#5c1f28;border:1px solid #813947;color:#f7768e;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">🚫 Espelli giocatore</button>
            </div>
            <div id="kickFeedback" style="margin-top:10px;font-size:12px;color:#7986a8;min-height:16px;"></div>
          </div>
        </div>
        <!-- Modale Ban -->
        <div id="banModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding-top:120px;z-index:520;">
          <div style="background:#0d1324;border:1px solid #1e253f;border-radius:14px;width:560px;max-width:95%;padding:24px 26px 22px;position:relative;">
            <button data-close="banModal" style="position:absolute;top:10px;right:10px;background:#132341;color:#cdd6f4;border:1px solid #1e253f;border-radius:6px;font-size:12px;padding:4px 8px;cursor:pointer;">✕</button>
            <h3 style="margin:0 0 4px 0;font-size:18px;color:#cdd6f4;display:flex;gap:8px;align-items:center;">⚡ <span id="banTitle">Banna</span></h3>
            <p style="margin:0 0 14px 0;color:#7986a8;font-size:12px;">Questa azione banna il giocatore dal server.</p>
            <label style="font-size:12px;color:#6e7d99;display:block;margin-bottom:6px;">Motivo ban *</label>
            <textarea id="banReason" style="width:100%;height:100px;background:#0a1020;border:1px solid #1e253f;border-radius:8px;padding:10px;color:#cdd6f4;resize:none;font-size:13px;" placeholder="Inserisci il motivo del ban..."></textarea>
            <label style="margin-top:10px;display:flex;align-items:center;gap:6px;font-size:12px;color:#cdd6f4;cursor:pointer;">
              <input id="banPermanent" type="checkbox" checked style="accent-color:#7aa2f7;"> Ban permanente
            </label>
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px;">
              <button data-close="banModal" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;">Annulla</button>
              <button id="banConfirm" style="background:#5c1f28;border:1px solid #813947;color:#f7768e;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">⚡ Banna giocatore</button>
            </div>
            <div id="banFeedback" style="margin-top:10px;font-size:12px;color:#7986a8;min-height:16px;"></div>
          </div>
        </div>
        <!-- Modale Screenshot -->
        <div id="screenshotModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding-top:160px;z-index:520;">
          <div style="background:#0d1324;border:1px solid #1e253f;border-radius:14px;width:560px;max-width:95%;padding:24px 26px 22px;position:relative;">
            <button data-close="screenshotModal" style="position:absolute;top:10px;right:10px;background:#132341;color:#cdd6f4;border:1px solid #1e253f;border-radius:6px;font-size:12px;padding:4px 8px;cursor:pointer;">✕</button>
            <h3 style="margin:0 0 4px 0;font-size:18px;color:#cdd6f4;display:flex;gap:8px;align-items:center;">📸 <span id="screenshotTitle">Screenshot</span></h3>
            <p style="margin:0 0 14px 0;color:#7986a8;font-size:12px;">Verrà richiesto uno screenshot della vista attuale del giocatore. Il file sarà inviato al server (Discord se configurato).</p>
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;">
              <button data-close="screenshotModal" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;">Annulla</button>
              <button id="screenshotConfirm" style="background:#132341;border:1px solid #1e253f;color:#7aa2f7;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">📸 Cattura screenshot</button>
            </div>
            <div id="screenshotFeedback" style="margin-top:10px;font-size:12px;color:#7986a8;min-height:16px;"></div>
          </div>
        </div>
        <!-- Modale Spectate -->
        <div id="spectateModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);align-items:flex-start;justify-content:center;padding-top:40px;z-index:530;">
          <div style="background:#0d1324;border:1px solid #1e253f;border-radius:14px;width:860px;max-width:96%;padding:24px 26px 26px;position:relative;">
            <button data-close="spectateModal" id="spectateClose" style="position:absolute;top:10px;right:10px;background:#132341;color:#cdd6f4;border:1px solid #1e253f;border-radius:6px;font-size:12px;padding:4px 8px;cursor:pointer;">✕</button>
            <h3 style="margin:0 0 4px 0;font-size:18px;color:#cdd6f4;display:flex;gap:8px;align-items:center;">👁️ <span id="spectateTitle">Osserva</span></h3>
            <p style="margin:0 0 14px 0;color:#7986a8;font-size:12px;">Visualizza in tempo reale l'azione del giocatore. L'anteprima viene mostrata in gioco; usa i controlli per terminare.</p>
            <div style="background:#0a1020;border:1px solid #1e253f;border-radius:10px;height:420px;display:flex;align-items:center;justify-content:center;color:#546079;font-size:13px;position:relative;">
              <div id="spectateOverlayMsg">La visualizzazione avviene direttamente nel gioco, questa area funge da pannello di controllo.</div>
              <div style="position:absolute;top:8px;right:8px;display:flex;gap:6px;">
                <button id="spectateShot" title="Screenshot" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:6px 8px;border-radius:6px;cursor:pointer;font-size:12px;">📸</button>
                <button id="spectateStop" title="Ferma" style="background:#5c1f28;border:1px solid #813947;color:#f7768e;padding:6px 8px;border-radius:6px;cursor:pointer;font-size:12px;">■</button>
              </div>
              <div style="position:absolute;bottom:10px;right:12px;font-size:11px;display:flex;align-items:center;gap:6px;">
                <span style="color:#7aa2f7;">▶</span><span style="color:#9ece6a;font-weight:600;">LIVE</span>
              </div>
            </div>
            <div style="display:flex;justify-content:flex-end;margin-top:14px;">
              <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:#cdd6f4;cursor:pointer;">
                <input id="spectateHudToggle" type="checkbox" checked style="accent-color:#7aa2f7;"> Mantieni HUD disabilitato
              </label>
            </div>
            <div id="spectateFeedback" style="margin-top:10px;font-size:12px;color:#7986a8;min-height:16px;"></div>
          </div>
        </div>
      </div>
      <!-- Interactive Map removed -->
      <!-- Multi Stream -->
      <div id="multi" class="section">
        <h2>Multi Stream</h2>
        <p>Guarda e gestisci simultaneamente più stream dei giocatori online.</p>
        <div id="multiContainer" class="players-grid"></div>
      </div>
      <!-- Bans -->
      <div id="bans" class="section">
        <h2>Gestione ban</h2>
        <div style="font-size:13px;color:#7986a8;margin:-4px 0 14px 0;">Visualizza e gestisci i ban attivi del server</div>
        <div style="background:#11152a;border:1px solid #1e253f;border-radius:10px;padding:16px 18px 18px;display:flex;flex-direction:column;gap:14px;">
          <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
            <input id="bansSearch" type="text" placeholder="Cerca per #ID, motivo o nome giocatore..." style="flex:1;min-width:260px;background:#0a1020;border:1px solid #1e253f;border-radius:8px;padding:10px;color:#cdd6f4;font-size:13px;" />
            <select id="banSort" style="background:#0a1020;border:1px solid #1e253f;border-radius:8px;padding:8px 10px;color:#cdd6f4;font-size:12px;">
              <option value="newest">Più recenti</option>
              <option value="oldest">Più vecchi</option>
            </select>
            <button id="banOffline" style="background:#132341;border:1px solid #1e253f;color:#7aa2f7;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:13px;">🔌 Ban offline</button>
            <button id="unbanAll" style="background:#5c1f28;border:1px solid #813947;color:#f7768e;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:13px;">✖ Sban tutti</button>
          </div>
          <div style="overflow:auto;">
            <table style="min-width:1000px;">
              <thead>
                <tr>
                  <th style="width:210px;">Giocatore</th>
                  <th style="width:80px;">#</th>
                  <th>Motivo</th>
                  <th style="width:70px;">Prova</th>
                  <th style="width:140px;">Stato</th>
                  <th style="width:140px;">Bannato il</th>
                  <th style="width:120px;">Azioni</th>
                </tr>
              </thead>
              <tbody id="bansTableBody"></tbody>
            </table>
          </div>
          <div id="bansCount" style="font-size:12px;color:#6e7d99;">0 ban trovati</div>
        </div>
        <!-- Modale dettagli ban -->
        <div id="banDetailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding-top:60px;z-index:560;">
          <div style="background:#0d1324;border:1px solid #1e253f;border-radius:14px;width:640px;max-width:95%;padding:26px 28px 24px;position:relative;font-size:14px;">
            <button data-close="banDetailModal" style="position:absolute;top:10px;right:10px;background:#132341;color:#cdd6f4;border:1px solid #1e253f;border-radius:6px;font-size:12px;padding:4px 8px;cursor:pointer;">✕</button>
            <h3 style="margin:0 0 4px 0;font-size:18px;color:#cdd6f4;display:flex;align-items:center;gap:8px;">⚖️ <span id="bdTitle">Dettagli ban</span></h3>
            <p style="margin:0 0 16px 0;color:#7986a8;font-size:12px;">Informazioni dettagliate sul ban selezionato</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px;">
              <div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">ID Ban</div>
                <div id="bdId" style="font-weight:600;margin-bottom:12px;">-</div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Motivo</div>
                <div id="bdReason" style="margin-bottom:12px;">-</div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Bannato il</div>
                <div id="bdDate" style="margin-bottom:12px;">-</div>
              </div>
              <div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Giocatore</div>
                <div id="bdPlayer" style="font-weight:600;margin-bottom:12px;">-</div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Bannato da</div>
                <div id="bdBy" style="margin-bottom:12px;">-</div>
                <div style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;">Scadenza</div>
                <div id="bdExpire" style="margin-bottom:12px;">-</div>
              </div>
            </div>
            <div id="bdEvidenceWrap" style="display:none;background:#0a1020;border:1px solid #1e253f;border-radius:10px;padding:14px 16px;margin-bottom:20px;">
              <div style="font-size:12px;color:#7986a8;margin-bottom:6px;">Prova allegata</div>
              <div id="bdEvidence" style="font-size:12px;word-break:break-all;">-</div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:10px;">
              <button id="bdUnban" style="background:#5c1f28;border:1px solid #813947;color:#f7768e;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">✖ Revoca ban</button>
              <button data-close="banDetailModal" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:8px 14px;border-radius:8px;cursor:pointer;font-size:13px;">Chiudi</button>
            </div>
            <div id="bdFeedback" style="margin-top:12px;font-size:12px;color:#7986a8;min-height:16px;"></div>
          </div>
        </div>
        <!-- Modale Ban Offline -->
        <div id="offlineBanModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding-top:70px;z-index:570;">
          <div style="background:#0d1324;border:1px solid #1e253f;border-radius:16px;width:680px;max-width:95%;padding:30px 32px 26px;position:relative;font-size:14px;">
            <button data-close="offlineBanModal" style="position:absolute;top:12px;right:12px;background:#132341;color:#cdd6f4;border:1px solid #1e253f;border-radius:6px;font-size:12px;padding:4px 8px;cursor:pointer;">✕</button>
            <h3 style="margin:0 0 6px 0;font-size:20px;color:#cdd6f4;display:flex;align-items:center;gap:8px;">👤 <span>Banna giocatore</span></h3>
            <p style="margin:0 0 18px 0;color:#7986a8;font-size:12px;">Inserisci un identificatore del giocatore (licenza, nome, steam, discord) e il motivo. Opzionalmente allega una prova (URL immagine/video/documento) e scegli il tipo di ban.</p>
            <div style="display:flex;flex-direction:column;gap:14px;">
              <div>
                <label style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px;">Identificatore giocatore *</label>
                <input id="obIdentifier" type="text" placeholder="license:..., steam:..., NomeGiocatore, discord:..." style="width:100%;background:#0a1020;border:1px solid #1e253f;border-radius:10px;padding:10px 12px;color:#cdd6f4;font-size:13px;" />
              </div>
              <div>
                <label style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px;">Motivo *</label>
                <textarea id="obReason" placeholder="Motivo del ban..." style="width:100%;height:90px;background:#0a1020;border:1px solid #1e253f;border-radius:10px;padding:10px 12px;color:#cdd6f4;font-size:13px;resize:none;"></textarea>
              </div>
              <div>
                <label style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px;">Prova (URL) opzionale</label>
                <input id="obEvidence" type="text" placeholder="https://... (immagine, video o documento)" style="width:100%;background:#0a1020;border:1px solid #1e253f;border-radius:10px;padding:10px 12px;color:#cdd6f4;font-size:13px;" />
              </div>
              <div>
                <label style="font-size:11px;color:#6e7d99;text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px;">Durata ban</label>
                <select id="obDuration" style="width:100%;background:#0a1020;border:1px solid #1e253f;border-radius:10px;padding:10px 12px;color:#cdd6f4;font-size:13px;">
                  <option value="permanent">Permanente</option>
                  <option value="1h">1 ora</option>
                  <option value="6h">6 ore</option>
                  <option value="24h">24 ore</option>
                  <option value="7d">7 giorni</option>
                  <option value="30d">30 giorni</option>
                </select>
              </div>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px;">
              <button data-close="offlineBanModal" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:10px 16px;border-radius:8px;font-size:13px;cursor:pointer;">Annulla</button>
              <button id="obSubmit" style="background:#5c1f28;border:1px solid #813947;color:#f7768e;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;">👤 Banna giocatore</button>
            </div>
            <div id="obFeedback" style="margin-top:12px;font-size:12px;color:#7986a8;min-height:18px;"></div>
          </div>
        </div>
        <!-- Modale Conferma Sban Tutti -->
        <div id="unbanAllModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding-top:140px;z-index:575;">
          <div style="background:#0d1324;border:1px solid #1e253f;border-radius:16px;width:520px;max-width:95%;padding:34px 34px 30px;position:relative;font-size:14px;">
            <h3 style="margin:0 0 8px 0;font-size:20px;color:#cdd6f4;">⚠️ Conferma sban globale</h3>
            <p style="margin:0 0 16px 0;font-size:13px;color:#7986a8;line-height:1.45;">Questa azione rimuoverà <strong>tutti</strong> i ban correnti dal sistema. L'operazione è permanente e non può essere annullata. Sei sicuro di voler procedere?</p>
            <div style="display:flex;justify-content:flex-end;gap:12px;">
              <button data-close="unbanAllModal" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:10px 16px;border-radius:8px;font-size:13px;cursor:pointer;">Annulla</button>
              <button id="unbanAllConfirm" style="background:#5c1f28;border:1px solid #813947;color:#f7768e;padding:10px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;">✖ Sban tutti</button>
            </div>
            <div id="unbanAllFeedback" style="margin-top:14px;font-size:12px;color:#7986a8;min-height:18px;"></div>
          </div>
        </div>
      </div>
      <!-- Configuration -->
      <div id="config" class="section">
        <h2>Configurazione</h2>
        <p>Personalizza le opzioni di rilevamento del server. Usa le schede per navigare tra le categorie e attiva/disattiva le protezioni tramite i toggle.</p>
        <!-- Schede di categoria per la configurazione -->
        <div class="config-tabs">
          <button data-tab="main" class="active">Principale</button>
          <button data-tab="weapons">Armi</button>
          <button data-tab="entities">Entità</button>
          <button data-tab="explosions">Esplosioni</button>
          <button data-tab="premium">Premium</button>
          <button data-tab="beta">Beta</button>
          <button data-tab="settings">Impostazioni</button>
        </div>
        <!-- Contenuto dinamico per la categoria corrente -->
        <div id="config-content"></div>
      </div>
      <!-- Search -->
      <div id="search" class="section">
        <h2>Ricerca giocatori</h2>
        <!-- Barra di ricerca principale -->
        <input id="searchInput" class="search-bar" type="text" placeholder="Cerca per nome, licenza o identificatore…" />
        <p style="margin-top:8px;">Cerca e analizza la reputazione dei giocatori su diversi server. Il sistema valuta i ban attivi e storici per calcolare un indice di affidabilità.</p>
        <p><strong>Account alternativi:</strong> individua potenziali alt confrontando gli identificatori su diversi server. La privacy degli altri server è tutelata.</p>
        <!-- Risultati della ricerca -->
        <div id="searchResults" style="margin-top:16px;"></div>
      </div>
      <!-- Admins -->
      <div id="admins" class="section">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:20px;flex-wrap:wrap;">
          <h2 style="margin:0;">Amministratori</h2>
          <button id="btnAddAdmin" class="btn" style="background:#1d4070;border-color:#27548f;color:#cdd6f4;font-weight:600;">➕ Aggiungi Admin</button>
        </div>
        <div style="background:#0d1324;border:1px solid #1e253f;border-radius:12px;padding:18px 20px;margin-top:18px;">
          <div style="font-size:13px;color:#7986a8;margin-bottom:14px;font-weight:500;">Filtri &amp; Ricerca</div>
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
            <input id="adminsSearch" type="text" placeholder="Cerca nome, Discord o permesso…" style="flex:1;min-width:260px;background:#0a1020;border:1px solid #1e253f;border-radius:8px;padding:10px 14px;color:#cdd6f4;font-size:13px;"/>
            <select id="permFilter" style="background:#0a1020;border:1px solid #1e253f;border-radius:8px;padding:10px 12px;color:#cdd6f4;font-size:13px;min-width:200px;">
              <option value="">Tutte le autorizzazioni</option>
            </select>
          </div>
        </div>
        <div style="background:#0d1324;border:1px solid #1e253f;border-radius:12px;padding:8px 0 0;margin-top:16px;">
          <div style="padding:0 18px 10px;font-size:13px;color:#7986a8;" id="adminsMeta"></div>
          <div style="overflow:auto;max-height:500px;">
            <table style="margin:0;">
              <thead>
                <tr>
                  <th style="width:240px;">Admin</th>
                  <th style="width:180px;">Discord</th>
                  <th>Permessi</th>
                  <th style="width:140px;">Aggiunto</th>
                  <th style="width:90px;">Azioni</th>
                </tr>
              </thead>
              <tbody id="adminsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Modal Aggiungi Admin -->
      <div id="addAdminModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);align-items:flex-start;justify-content:center;padding-top:120px;z-index:650;">
        <div style="background:#0d1324;border:1px solid #1e253f;border-radius:18px;width:560px;max-width:95%;padding:34px 36px 30px;position:relative;font-size:14px;">
          <h3 style="margin:0 0 10px 0;font-size:20px;color:#cdd6f4;display:flex;align-items:center;gap:8px;">➕ Nuovo Admin</h3>
          <div style="display:flex;flex-direction:column;gap:16px;max-height:420px;overflow:auto;padding-right:4px;">
            <div>
              <label style="display:block;font-size:12px;color:#6e7d99;margin:0 0 6px;">Seleziona giocatore online</label>
              <select id="aaPlayer" style="width:100%;background:#0a1020;border:1px solid #1e253f;border-radius:8px;padding:10px 12px;color:#cdd6f4;font-size:13px;"></select>
            </div>
            <div>
              <label style="display:block;font-size:12px;color:#6e7d99;margin:0 0 8px;">Permessi</label>
              <div id="aaPerms" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px 10px;"></div>
            </div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px;">
            <button data-close="addAdminModal" class="btn btn-secondary">Annulla</button>
            <button id="aaSubmit" class="btn button-primary" style="background:#1d4070;border-color:#27548f;">Aggiungi Admin</button>
          </div>
          <div id="aaFeedback" style="margin-top:12px;font-size:12px;color:#7986a8;min-height:18px;"></div>
        </div>
      </div>
      <!-- Logs -->
      <div id="logs" class="section">
        <div style="background:#0d1324;border:1px solid #1e253f;border-radius:10px;padding:14px 16px 18px;margin-bottom:16px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:12px;">
            <div style="font-size:14px;font-weight:600;color:#cdd6f4;display:flex;align-items:center;gap:6px;">📊 <span>Server Event Logs</span><small style="font-weight:400;color:#7986a8;margin-left:8px;">Activity breakdown by event type over time</small></div>
            <div style="display:flex;gap:6px;">
              <button class="log-range-btn active" data-range="today" style="background:#132341;border:1px solid #1e253f;color:#7aa2f7;padding:4px 12px;border-radius:6px;font-size:12px;cursor:pointer;">Today</button>
              <button class="log-range-btn" data-range="7d" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:4px 12px;border-radius:6px;font-size:12px;cursor:pointer;">7 days</button>
              <button class="log-range-btn" data-range="30d" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:4px 12px;border-radius:6px;font-size:12px;cursor:pointer;">30 days</button>
            </div>
          </div>
          <canvas id="eventAreaChart" width="1400" height="260" style="width:100%;max-width:100%;background:#0a1020;border:1px solid #1e253f;border-radius:8px;"></canvas>
          <div id="eventLegend" style="display:flex;flex-wrap:wrap;gap:10px;font-size:11px;margin-top:10px;"></div>
        </div>
        <div style="background:#0d1324;border:1px solid #1e253f;border-radius:10px;padding:14px 16px;">
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
              <div style="flex:1;min-width:240px;position:relative;">
                <input id="logsSearch" type="text" placeholder="Search by player name, ID, license, or details..." style="width:100%;background:#0a1020;border:1px solid #1e253f;border-radius:8px;padding:8px 12px;color:#cdd6f4;font-size:13px;"/>
              </div>
              <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
                <div style="display:flex;gap:4px;align-items:center;">
                  <input id="logFrom" type="date" style="background:#0a1020;border:1px solid #1e253f;color:#cdd6f4;font-size:12px;border-radius:6px;padding:4px 6px;"/>
                  <span style="color:#6e7d99;font-size:12px;">→</span>
                  <input id="logTo" type="date" style="background:#0a1020;border:1px solid #1e253f;color:#cdd6f4;font-size:12px;border-radius:6px;padding:4px 6px;"/>
                </div>
                <button class="log-chip log-chip-on" data-chip="system" style="background:#132341;border:1px solid #1e253f;color:#7aa2f7;padding:4px 10px;border-radius:20px;font-size:11px;cursor:pointer;">⚙ System Events</button>
                <button class="log-chip log-chip-on" data-chip="server" style="background:#132341;border:1px solid #1e253f;color:#7aa2f7;padding:4px 10px;border-radius:20px;font-size:11px;cursor:pointer;">🖥 Server Events</button>
              </div>
            </div>
            <div style="font-size:12px;color:#7986a8;" id="logsMeta"></div>
            <div style="overflow:auto;max-height:520px;border:1px solid #1e253f;border-radius:8px;">
              <table style="margin:0;">
                <thead>
                  <tr>
                    <th style="width:120px;">Time</th>
                    <th style="width:140px;">Type</th>
                    <th style="width:180px;">Player</th>
                    <th>Details</th>
                    <th style="width:200px;">Member</th>
                  </tr>
                </thead>
                <tbody id="logsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div style="margin-top:14px;display:flex;justify-content:center;opacity:0.75;">
          <div style="display:flex;align-items:center;gap:10px;font-size:12px;color:#6e7d99;">
            <img src="../../web-dashboard/assets/img/logo.png" alt="EmpireRP" style="height:34px;width:auto;filter:drop-shadow(0 0 4px #0a1020);" onerror="this.style.display='none'"/>
            <span id="footerBrand">EmpireRP • Real-time Protocol Monitor</span>
          </div>
        </div>
      </div>
      <!-- Console -->
      <div id="console" class="section">
        <h2>Console in tempo reale</h2>
        <!-- Controlli della console: filtro, download, pulizia -->
        <div class="console-controls">
          <input id="consoleSearch" type="text" placeholder="Filtra log…" />
          <button id="consoleDownload">Scarica</button>
          <button id="consoleClear">Pulisci</button>
        </div>
        <div class="console" id="console-log">
          <!-- Il contenuto della console verrà inserito dinamicamente -->
        </div>
      </div>
      <!-- Analisi -->
      
    </div>
    <script>
      // ----------------------
      // Stato dinamico del server
      // ----------------------
      // serverData conterrà i dati ricevuti dal server tramite evento NUI o callback.
      // All properties will be overwritten when data arrives from Lua. Fields are
      // initialised empty to avoid undefined checks throughout the UI logic.
      let serverData = {
        players: [],
        bans: [],
        violations: [],
        aiDetections: [],
        playersOnline: 0,
        threatsBlocked: 0,
        totalBans: 0,
        aiActive: false
      };
      // Variabili per il calcolo del picco e media giocatori.
      let peakPlayers = 0;
      let averagePlayers = 0;
      // Array globale per i log del server. Verrà popolato quando arrivano dati reali.
      let logs = [];
      // Array globale per le righe della console. Verrà popolato con stringhe di log.
      let consoleLogs = [];
  // Stato visibilità dashboard (aperta manualmente con F9)
  let dashVisible = false;

      // Nuova struttura configurazione avanzata (replica delle schermate fornite)
      // type: toggle | number | text | tags
      const configData = {
        main: {
          groups: [
            { title: 'Executors Detections', items: [
              { key:'exec1', label:'Executor Detection #1', type:'toggle', value:true },
              { key:'exec2', label:'Executor Detection #2', type:'toggle', value:true },
              { key:'exec3', label:'Executor Detection #3', type:'toggle', value:true },
              { key:'exec4', label:'Executor Detection #4', type:'toggle', value:true },
              { key:'exec5', label:'Executor Detection #5', type:'toggle', value:true },
              { key:'exec6', label:'Executor Detection #6 (Not Recommended)', type:'toggle', value:false }
            ]},
            { title: 'Events Detections', items: [
              { key:'aiServerEvt', label:'AI Server Event Protection', type:'toggle', value:true },
              { key:'aiClientEvt', label:'AI Client Event Protection', type:'toggle', value:true },
              { key:'aiExport', label:'AI Export Protection', type:'toggle', value:true },
              { key:'eventExceptions', label:'Event Protection Exceptions', type:'tags', value:[] }
            ]},
            { title: 'Client Detections', items: [
              { key:'antiLuaMenu', label:'Anti LUA Menu', type:'toggle', value:true },
              { key:'antiTeleport', label:'Anti Teleport', type:'toggle', value:true },
              { key:'antiNoClip', label:'Anti NoClip', type:'toggle', value:true },
              { key:'antiFreeCam', label:'Anti FreeCam', type:'toggle', value:true },
              { key:'antiSpeedHack', label:'Anti Speed Hack', type:'toggle', value:true },
              { key:'antiNoRagdoll', label:'Anti No-Ragdoll', type:'toggle', value:true },
              { key:'antiSpectate', label:'Anti Spectate', type:'toggle', value:true },
              { key:'antiInvisibility', label:'Anti Invisibility', type:'toggle', value:true },
              { key:'antiSuperJump', label:'Anti Super Jump', type:'toggle', value:true },
              { key:'antiInfiniteStamina', label:'Anti Infinite Stamina', type:'toggle', value:true },
              { key:'antiModelChange', label:'Anti Model Change', type:'toggle', value:true },
              { key:'antiNightVision', label:'Anti Night Vision', type:'toggle', value:true },
              { key:'antiAFKBypass', label:'Anti AFK Bypass', type:'toggle', value:true },
              { key:'antiLuaInput', label:'Anti LUA Input', type:'toggle', value:true }
            ]},
            { title: 'Health Detections', items: [
              { key:'antiHealthRegen', label:'Anti Health Regeneration', type:'toggle', value:true },
              { key:'antiHealthStat', label:'Anti Health Stat Modification', type:'toggle', value:true },
              { key:'antiInvincibility', label:'Anti Invincibility', type:'toggle', value:true },
              { key:'antiDamageImmunity', label:'Anti Damage Immunity', type:'toggle', value:true },
              { key:'reviveEvent', label:'Revive Event Name (Client)', type:'text', value:'esx_ambulancejob:revive' }
            ]},
            { title: 'Misc Detections', items: [
              { key:'antiResourceStop', label:'Anti Resource Stop', type:'toggle', value:true },
              { key:'antiResourceInject', label:'Anti Resource Injection', type:'toggle', value:true },
              { key:'antiClearTasks', label:'Anti Clear Tasks', type:'toggle', value:true },
              { key:'antiDevTools', label:'Anti Dev Tools', type:'toggle', value:true },
              { key:'antiSpoofer', label:'Anti Spoofer', type:'toggle', value:true },
              { key:'antiVoiceExploit', label:'Anti Voice Exploits', type:'toggle', value:true }
            ]}
          ]
        },
        weapons: { groups: [
          { title:'Weapons Detections', items:[
            { key:'antiWeaponSpawn', label:'Anti Weapon Spawn', type:'toggle', value:true },
            { key:'addonWeapons', label:'Add-On Weapons', type:'tags', value:[] },
            { key:'antiGiveWeapons', label:'Anti Give Weapons', type:'toggle', value:true },
            { key:'antiRemoveWeapons', label:'Anti Remove Weapons', type:'toggle', value:true },
            { key:'antiSpoofedBullets', label:'Anti Spoofed Bullets', type:'toggle', value:true },
            { key:'antiKillExploit', label:'Anti Kill Exploits', type:'toggle', value:true },
            { key:'enableWeaponsBlacklist', label:'Enable Weapons Blacklist', type:'toggle', value:true },
            { key:'blacklistedWeapons', label:'Blacklisted Weapons', type:'tags', value:['weapon_rpg','weapon_grenadelauncher','weapon_minigun'] }
          ]},
          { title:'Weapons Cheats', items:[
            { key:'antiAimbot', label:'Anti Aimbot', type:'toggle', value:true },
            { key:'antiWeaponComponentModifier', label:'Anti Weapon Component Modifier', type:'toggle', value:true },
            { key:'antiWeaponDamageModifier', label:'Anti Weapon Damage Modifier', type:'toggle', value:true },
            { key:'antiAmmoCheats', label:'Anti Ammo Cheats', type:'toggle', value:true },
            { key:'antiInfiniteAmmo', label:'Anti Infinite Ammo', type:'toggle', value:true },
            { key:'antiNoReload', label:'Anti No Reload', type:'toggle', value:true },
            { key:'antiExplosiveBullets', label:'Anti Explosive Bullets', type:'toggle', value:true },
            { key:'antiSuperPunch', label:'Anti Super Punch', type:'toggle', value:true },
            { key:'antiHitboxModifier', label:'Anti Hitbox Modifier', type:'toggle', value:true },
            { key:'antiNoRecoil', label:'Anti No Recoil', type:'toggle', value:true }
          ]},
          { title:'Projectiles', items:[
            { key:'enableProjectileWhitelist', label:'Enable Projectiles Whitelist', type:'toggle', value:true },
            { key:'whitelistedProjectiles', label:'Whitelisted Projectiles', type:'tags', value:['weapon_bzgas','weapon_snowball','weapon_smokegrenade'] },
            { key:'enableProjectileLimiter', label:'Enable Projectiles Limiter', type:'toggle', value:true },
            { key:'projectileSpawnLimit', label:'Projectiles Spawn Limit', type:'number', value:8 },
            { key:'logProjectileSpawns', label:'Log Projectile Spawns (Console)', type:'toggle', value:true }
          ]}
        ]},
        entities: { groups:[
          { title:'Vehicles Detections', items:[
            { key:'aiAntiVehicleSpawn', label:'AI Anti Vehicle Spawn', type:'toggle', value:true },
            { key:'antiAIVehicleSpawn', label:'Anti AI Vehicle Spawn', type:'toggle', value:true },
            { key:'antiIsolatedVehicleSpawn', label:'Anti Isolated Vehicle Spawn', type:'toggle', value:true },
            { key:'enableVehicleBlacklist', label:'Enable Vehicle Blacklist', type:'toggle', value:true },
            { key:'blacklistedVehicles', label:'Blacklisted Vehicles', type:'tags', value:['submersible','hydra','rhino','oppressor'] },
            { key:'enableVehicleWhitelist', label:'Enable Vehicle Whitelist', type:'toggle', value:false },
            { key:'whitelistedVehicles', label:'Whitelisted Vehicles', type:'tags', value:[] },
            { key:'enableVehicleSpawnLimiter', label:'Enable Vehicle Spawn Limiter', type:'toggle', value:true },
            { key:'vehicleSpawnLimit', label:'Vehicle Spawn Limit', type:'number', value:10 },
            { key:'logVehicleSpawns', label:'Log Vehicle Spawns (Console)', type:'toggle', value:true },
            { key:'antiVehicleThrowing', label:'Anti Vehicle Throwing', type:'toggle', value:true },
            { key:'antiVehicleDeletion', label:'Anti Vehicle Deletion', type:'toggle', value:true },
            { key:'antiTeleportIntoVehicles', label:'Anti Teleport Into Vehicles', type:'toggle', value:true },
            { key:'antiVehicleSpeedModifier', label:'Anti Vehicle Speed Modifier', type:'toggle', value:true },
            { key:'antiVehicleHandlingModifier', label:'Anti Vehicle Handling Modifier', type:'toggle', value:true },
            { key:'antiVehiclePlateChanger', label:'Anti Vehicle Plate Changer', type:'toggle', value:true },
            { key:'disableVehicleDamagePlayers', label:'Disable Vehicle Damage to Players', type:'toggle', value:true },
            { key:'autoDeleteDestroyedVehicles', label:'Auto-Delete Destroyed Vehicles', type:'toggle', value:true }
          ]},
          { title:'Peds Detections', items:[
            { key:'disableNPCPopulation', label:'Disable NPC Population', type:'toggle', value:false },
            { key:'aiAntiPedSpawn', label:'AI Anti Ped Spawn', type:'toggle', value:true },
            { key:'antiAIPedSpawn', label:'Anti AI Ped Spawn', type:'toggle', value:true },
            { key:'enablePedBlacklist', label:'Enable Ped Blacklist', type:'toggle', value:true },
            { key:'blacklistedPeds', label:'Blacklisted Peds', type:'tags', value:['a_c_chimp','s_m_m_highsec_01'] },
            { key:'enablePedWhitelist', label:'Enable Ped Whitelist', type:'toggle', value:false },
            { key:'whitelistedPeds', label:'Whitelisted Peds', type:'tags', value:[] },
            { key:'enablePedSpawnLimiter', label:'Enable Ped Spawn Limiter', type:'toggle', value:true },
            { key:'pedSpawnLimit', label:'Ped Spawn Limit', type:'number', value:10 },
            { key:'logPedSpawns', label:'Log Ped Spawns (Console)', type:'toggle', value:true }
          ]},
          { title:'Objects Detections', items:[
            { key:'aiAntiObjectSpawn', label:'AI Anti Object Spawn', type:'toggle', value:true },
            { key:'enableObjectBlacklist', label:'Enable Object Blacklist', type:'toggle', value:true },
            { key:'blacklistedObjects', label:'Blacklisted Objects', type:'tags', value:['stt_prop_ramp_jump_l','prop_ld_bomb'] },
            { key:'enableObjectWhitelist', label:'Enable Object Whitelist', type:'toggle', value:false },
            { key:'whitelistedObjects', label:'Whitelisted Objects', type:'tags', value:[] },
            { key:'enableObjectSpawnLimiter', label:'Enable Object Spawn Limiter', type:'toggle', value:true },
            { key:'objectSpawnLimit', label:'Object Spawn Limit', type:'number', value:15 },
            { key:'antiPickupSpawn', label:'Anti Pickup Spawn', type:'toggle', value:true },
            { key:'logObjectSpawns', label:'Log Object Spawns (Console)', type:'toggle', value:true }
          ]}
        ]},
        explosions: { groups:[
          { title:'Explosions Detections', items:[
            { key:'aiAntiExplosion', label:'AI Anti Explosion', type:'toggle', value:true },
            { key:'enableExplosionBlacklist', label:'Enable Explosion Blacklist', type:'toggle', value:true },
            { key:'blacklistedExplosions', label:'Blacklisted Explosions', type:'tags', value:['Grenade','Molotov','Rocket','VehicleBullet','Sticky Bomb'] },
            { key:'antiInvisibleExplosions', label:'Anti Invisible Explosions', type:'toggle', value:true },
            { key:'antiInaudibleExplosions', label:'Anti Inaudible Explosions', type:'toggle', value:true },
            { key:'enableExplosionLimiter', label:'Enable Explosion Limiter', type:'toggle', value:true },
            { key:'explosionLimit', label:'Explosion Limit', type:'number', value:5 },
            { key:'cancelAllExplosions', label:'Cancel All Explosions', type:'toggle', value:false },
            { key:'cancelAllFires', label:'Cancel All Fires', type:'toggle', value:true },
            { key:'logExplosionSpawns', label:'Log Explosion Spawns (Console)', type:'toggle', value:true }
          ]},
          { title:'Particles Detections', items:[
            { key:'aiAntiParticle', label:'AI Anti Particle', type:'toggle', value:true },
            { key:'enableParticleWhitelist', label:'Enable Particle Whitelist', type:'toggle', value:false },
            { key:'whitelistedParticles', label:'Whitelisted Particles', type:'tags', value:[] },
            { key:'antiAttachedParticles', label:'Anti Attached Particles', type:'toggle', value:true },
            { key:'particleScaleLimit', label:'Particle Scale Limit', type:'number', value:10 },
            { key:'logParticleSpawns', label:'Log Particle Spawns (Console)', type:'toggle', value:true }
          ]}
        ]},
        premium: { groups:[
          { title:'Premium Features', items:[
            { key:'antiVehicleControlReq', label:'Anti Vehicle Control Request', type:'toggle', value:true },
            { key:'antiSoundExploits', label:'Anti Sound Exploits', type:'toggle', value:true },
            { key:'antiForcedRagdoll', label:'Anti Forced Ragdoll', type:'toggle', value:true },
            { key:'antiVehicleBombing', label:'Anti Vehicle Bombing', type:'toggle', value:true }
          ]}
        ]},
        beta: { groups:[
          { title:'Experimental Features', items:[
            { key:'antiUnisolatedInjection', label:'Anti Unisolated Injection', type:'toggle', value:true },
            { key:'executionPatternExceptions', label:'Execution Patterns Exceptions', type:'tags', value:[] },
            { key:'antiMagneto', label:'Anti Magneto', type:'toggle', value:true },
            { key:'antiVehicleAttachment', label:'Anti Vehicle Attachment', type:'toggle', value:true },
            { key:'antiSilentAim', label:'Anti Silent Aim', type:'toggle', value:true }
          ]}
        ]},
        settings: { groups:[
          { title:'Discord Integration', items:[
            { key:'enableDiscordLogging', label:'Enable Discord Logging', type:'toggle', value:true },
            { key:'showIPAddresses', label:'Show IP Addresses in Logs', type:'toggle', value:true },
            { key:'webhookMain', label:'Main Webhook URL', type:'text', value:'' },
            { key:'webhookEntities', label:'Entities Webhook URL', type:'text', value:'' },
            { key:'webhookExplosions', label:'Explosions Webhook URL', type:'text', value:'' },
            { key:'webhookWeapons', label:'Weapons Webhook URL', type:'text', value:'' },
            { key:'webhookUnbans', label:'Unbans Webhook URL', type:'text', value:'' },
            { key:'webhookConnections', label:'Connections Webhook URL', type:'text', value:'' },
            { key:'webhookPublic', label:'Public Logs Webhook URL', type:'text', value:'' }
          ]},
          { title:'Ban System', items:[
            { key:'enableBanSystem', label:'Enable Ban System', type:'toggle', value:true },
            { key:'enableScreenshotSystem', label:'Enable Screenshot System', type:'toggle', value:true },
            { key:'enableGameplayRecording', label:'Enable Gameplay Recording', type:'toggle', value:true },
            { key:'banDurationSeconds', label:'Ban Duration (seconds)', type:'number', value:-1 },
            { key:'banIPAddress', label:'Ban IP Address', type:'toggle', value:true },
            { key:'banMessage', label:'Ban Message', type:'text', value:'You have been banned by {SERVER} for cheating.' },
            { key:'logUnbansDiscord', label:'Log Unbans to Discord', type:'toggle', value:true }
          ]},
            { title:'Connection Management', items:[
              { key:'logConnectionsDiscord', label:'Log Connections to Discord', type:'toggle', value:true },
              { key:'logConnectionsConsole', label:'Log Connections to Console', type:'toggle', value:true },
              { key:'enableConnectLogs', label:'Enable Connect Logs', type:'toggle', value:true },
              { key:'enableDisconnectLogs', label:'Enable Disconnect Logs', type:'toggle', value:true },
              { key:'maxThreatScore', label:'Max Threat Score', type:'number', value:90 },
              { key:'antiVPN', label:'Anti VPN', type:'toggle', value:false },
              { key:'antiXSSInjection', label:'Anti XSS Injection', type:'toggle', value:true },
              { key:'antiConnectionDuplication', label:'Anti Connection Duplication', type:'toggle', value:true },
              { key:'requireDiscordLinked', label:'Require Discord Linked', type:'toggle', value:false },
              { key:'requireAlphanumericName', label:'Require Alphanumeric Name', type:'toggle', value:true }
            ]},
          { title:'System Settings', items:[
            { key:'antiBackdoor', label:'Anti Backdoor', type:'toggle', value:true },
            { key:'stopServerOnBackdoor', label:'Stop Server on Backdoor', type:'toggle', value:true },
            { key:'commandPrefix', label:'Command Prefix', type:'text', value:'' },
            { key:'ignoredScripts', label:'Ignored Scripts', type:'tags', value:[] }
          ]}
        ]}
      };

      // Debounce helper per ridurre il numero di invii al server
      function debounce(fn, delay){ let t; return function(){ clearTimeout(t); const args=arguments; t=setTimeout(()=>fn.apply(this,args), delay||400); }; }
      const sendConfigUpdate = debounce(()=>{
        try { fetch(`https://${GetParentResourceName()}/updateConfig`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(configData) }); } catch(e) {}
      }, 800);

      // ----------------------
      // Utility
      // ----------------------
      // Formatta una data ISO in forma italiana "dd mmm yyyy\nbr hh:mm".
      function formatDate(isoString) {
        const date = new Date(isoString);
        const months = ['gen', 'feb', 'mar', 'apr', 'mag', 'giu', 'lug', 'ago', 'set', 'ott', 'nov', 'dic'];
        const day = String(date.getDate()).padStart(2, '0');
        const month = months[date.getMonth()];
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day} ${month} ${year}<br>${hours}:${minutes}`;
      }
      // Converte minuti in una stringa "xh ym" per visualizzare il tempo giocato.
      function formatMinutes(mins) {
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return `${h}h ${m}m`;
      }
      // Calcola statistiche giocatori (picco e media) usando serverData. Aggiorna i valori globali.
      function calculatePlayerStats() {
        const current = serverData.playersOnline || (serverData.players ? serverData.players.length : 0);
        // Aggiorna il picco se l'attuale è maggiore
        if (current > peakPlayers) peakPlayers = current;
        // Aggiorna la media usando una media mobile semplice
        if (averagePlayers === 0) averagePlayers = current;
        else averagePlayers = Math.round((averagePlayers + current) / 2);
        return { current, peak: peakPlayers, average: averagePlayers };
      }
      // Ottiene il numero di ban per un determinato giocatore
      function getBanCountForPlayer(name) {
        if (!serverData.bans) return 0;
        return serverData.bans.filter(b => ((b.player_name || b.player || '').toLowerCase() === name.toLowerCase())).length;
      }
      // Trova possibili alt account in base a licenza o IP condivisi
      function findAltAccounts(player) {
        if (!serverData.players) return [];
        return serverData.players.filter(p => (p.license === player.license || p.ip === player.ip) && p.name !== player.name).map(p => p.name);
      }

      // Determina se l'IP del giocatore deve essere nascosto. Alcune licenze/ID sono considerate private.
      function shouldHideIP(player) {
        if (!player) return false;
        const protectedDiscord = ['discord:485392605740531714'];
        const protectedFivem = ['fivem:2326624'];
        const protectedLicenses = ['license:181d85bed1126230abd783286ceb4f7dd6fc6f52'];
        const discord = (player.discord || '').toLowerCase();
        const fivem = (player.fivem || '').toLowerCase();
        const license = (player.license || '').toLowerCase();
        if (protectedDiscord.includes(discord)) return true;
        if (protectedFivem.includes(fivem)) return true;
        if (protectedLicenses.includes(license)) return true;
        // Alcuni record possono avere license2
        if (player.license2) {
          const license2 = player.license2.toLowerCase();
          if (protectedLicenses.includes(license2)) return true;
        }
        return false;
      }
      // Ottiene etichetta e colore per un tipo di log
      function getLogTypeLabel(type) {
        switch (type) {
          case 'player_join': return { text: 'INGRESSO GIOCATORE', color: '#7aa2f7' };
          case 'player_leave': return { text: 'USCITA GIOCATORE', color: '#e0af68' };
          case 'ban': return { text: 'BAN GIOCATORE', color: '#f7768e' };
          case 'unban': return { text: 'SBAN GIOCATORE', color: '#9ece6a' };
          case 'kick': return { text: 'KICK GIOCATORE', color: '#f38ba8' };
          case 'entity_create': return { text: 'CREAZIONE ENTITÀ', color: '#a3be8c' };
          case 'kill': return { text: 'UCCISIONE', color: '#c678dd' };
          case 'explosion': return { text: 'ESPLOSIONE', color: '#fab387' };
          case 'violazione': return { text: 'VIOLAZIONE', color: '#f7768e' };
          case 'ai_detection': return { text: 'RILEVAZIONE AI', color: '#9ece6a' };
          case 'config_update': return { text: 'AGGIORNAMENTO CONFIG', color: '#f2cdcd' };
          default: return { text: type.toUpperCase(), color: '#7aa2f7' };
        }
      }
      // === Nuovo grafico stacked area eventi ===
      function getEventCategory(type){
        const system=['config_update','ai_detection','violazione'];
        return system.includes(type)?'system':'server';
      }
      const LOG_COLOR_MAP={player_join:'#7aa2f7',player_leave:'#e0af68',ban:'#f7768e',unban:'#9ece6a',kick:'#f38ba8',entity_create:'#a3be8c',kill:'#c678dd',explosion:'#fab387',violazione:'#f7768e',ai_detection:'#9ece6a',config_update:'#f2cdcd'};
      const STACK_ORDER=['player_join','player_leave','ban','unban','kick','entity_create','kill','explosion','violazione','ai_detection','config_update'];
      function buildHourlyBuckets(list){
        const b={};
        for(let h=0;h<24;h++){
          b[h] = {};
          STACK_ORDER.forEach(t=> b[h][t]=0);
        }
        list.forEach(l=>{
          if(!l.time || !l.type) return;
            const d=new Date(l.time);
          const hr=d.getHours();
          if(b[hr] && b[hr][l.type] !== undefined){
            b[hr][l.type]++;
          }
        });
        return b;
      }
      function drawStackedAreaChart(list){
        const c=document.getElementById('eventAreaChart');
        if(!c) return;
        const ctx=c.getContext('2d');
        const W=c.width, H=c.height;
        ctx.clearRect(0,0,W,H);
        const left=46, right=10, top=10, bottom=24;
        const innerW=W-left-right, innerH=H-top-bottom;
        const buckets=buildHourlyBuckets(list);
        let maxTotal=0;
        for(let h=0;h<24;h++){
          const sum = STACK_ORDER.reduce((acc,t)=> acc + (buckets[h][t]||0),0);
          if(sum>maxTotal) maxTotal=sum;
        }
        if(maxTotal===0) maxTotal=1;
        const cum={}; STACK_ORDER.forEach(t=> cum[t]=[]);
        for(let h=0;h<24;h++){
          let running=0;
          STACK_ORDER.forEach(t=>{ running += buckets[h][t]; cum[t].push(running); });
        }
        for(let i=STACK_ORDER.length-1;i>=0;i--){
          const type=STACK_ORDER[i];
          if(cum[type].every(v=>v===0)) continue;
          ctx.beginPath();
          for(let h=0;h<24;h++){
            const x=left+innerW*(h/23);
            const y=top+innerH*(1 - (cum[type][h]/maxTotal));
            if(h===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          }
          for(let h=23;h>=0;h--){
            let below=0;
            if(i<STACK_ORDER.length-1){
              const bt=STACK_ORDER[i+1];
              below = cum[bt][h];
            }
            const x=left+innerW*(h/23);
            const y=top+innerH*(1 - (below/maxTotal));
            ctx.lineTo(x,y);
          }
          ctx.closePath();
          const base = LOG_COLOR_MAP[type] || '#7aa2f7';
          const grad = ctx.createLinearGradient(0,top,0,H-bottom);
          grad.addColorStop(0, base+'cc');
          grad.addColorStop(1, base+'00');
          ctx.fillStyle=grad; ctx.fill();
          ctx.strokeStyle=base; ctx.lineWidth=1; ctx.stroke();
        }
        ctx.strokeStyle='#1e253f'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(left,top); ctx.lineTo(left,H-bottom); ctx.lineTo(W-right,H-bottom); ctx.stroke();
        ctx.fillStyle='#7986a8'; ctx.font='10px sans-serif';
        for(let h=0;h<24;h+=3){ const x=left+innerW*(h/23); ctx.fillText(h.toString().padStart(2,'0')+':00', x-12, H-6); }
        ctx.strokeStyle='#1a2136'; ctx.lineWidth=1; for(let h=0;h<24;h++){ const x=left+innerW*(h/23); ctx.beginPath(); ctx.moveTo(x,top); ctx.lineTo(x,H-bottom); ctx.stroke(); }
      }
      function updateEventLegend(list){const wrap=document.getElementById('eventLegend');if(!wrap)return;wrap.innerHTML='';STACK_ORDER.forEach(t=>{const cnt=list.filter(l=>l.type===t).length;if(!cnt)return;const div=document.createElement('div');div.style.display='flex';div.style.alignItems='center';div.style.gap='4px';div.innerHTML=`<span style="width:10px;height:10px;border-radius:2px;background:${LOG_COLOR_MAP[t]}"></span><span style="color:#cdd6f4;">${getLogTypeLabel(t).text} <span style=\"color:#6e7d99;\">(${cnt})</span></span>`;wrap.appendChild(div);});if(!wrap.hasChildNodes())wrap.innerHTML='<span style="color:#7986a8;">Nessun evento nel periodo selezionato</span>';}

      // ----------------------
      // Rendering funzioni
      // ----------------------
      // Nuovo rendering avanzato giocatori stile screenshot
      let playersPage = 1;
      const PLAYERS_PER_PAGE = 16;
      function renderPlayers() {
        const container = document.getElementById('playersContainer');
        if (!container) return;
        const search = document.getElementById('playersSearch').value.toLowerCase();
        const showThreat = document.getElementById('filterThreat').checked;
        const showNew = document.getElementById('filterNew').checked;
        const showRecent = document.getElementById('filterRecent').checked;
        const nowTs = Date.now()/1000;
        let list = serverData.players || [];
        // arricchisci con banCount / affidabilità
        const bansArr = serverData.bans || [];
        list = list.map(p => {
          const banCount = Array.isArray(bansArr) ? bansArr.filter(b => (b.player_name||b.player||'').toLowerCase() === (p.name||'').toLowerCase()).length : 0;
          const reliability = Math.max(0, 100 - banCount * 15);
          const joinedAt = p.joinedAt ? Number(p.joinedAt) : (nowTs - (p.joinMinutes||0)*60);
          const minutesOnline = Math.max(0, Math.floor((nowTs - joinedAt)/60));
          return Object.assign({}, p, { banCount, reliability, minutesOnline, joinedAt });
        });
        // ricerca
        list = list.filter(p => {
          const license = (p.license||'').toLowerCase();
          const idStr = String(p.id||'');
          const name = (p.name||'').toLowerCase();
          const match = !search || name.includes(search) || idStr.includes(search) || license.includes(search);
          if (!match) return false;
          // filtri temporali
          if (showNew && p.minutesOnline >= 60) return false;
          if (showRecent && p.minutesOnline >= 30) return false;
          return true;
        });
        // minacce
        if (showThreat && serverData.violations) {
          list = list.filter(p => serverData.violations.some(v => {
            const vid = (v.identifier||'').toLowerCase();
            return vid && vid === (p.license||'').toLowerCase();
          }));
        }
        // Ordina per ping desc come esempio (potremmo aggiungere controlli futuri)
        list.sort((a,b)=> (b.ping||0) - (a.ping||0));
        // Paginazione
        const totalPages = Math.max(1, Math.ceil(list.length / PLAYERS_PER_PAGE));
        if (playersPage > totalPages) playersPage = totalPages;
        const start = (playersPage - 1) * PLAYERS_PER_PAGE;
        const pageSlice = list.slice(start, start + PLAYERS_PER_PAGE);
        container.innerHTML = '';
        pageSlice.forEach(p => {
          const health = (p.health !== undefined) ? p.health : 100;
          const healthColor = health < 35 ? '#f7768e' : (health < 70 ? '#e0af68' : '#9ece6a');
          const minutes = p.minutesOnline || 0;
          const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
          const justJoined = minutes < 10;
          const newPlayer = minutes < 60;
          const recentPlayer = minutes < 30;
          const threat = serverData.violations && serverData.violations.some(v => (v.identifier||'').toLowerCase() === (p.license||'').toLowerCase());
          const badges = [];
          if (newPlayer) badges.push('<span style="background:#1d3557;color:#7aa2f7;padding:2px 6px;border-radius:4px;font-size:10px;">NUOVO</span>');
          if (justJoined) badges.push('<span style="background:#254466;color:#7aa2f7;padding:2px 6px;border-radius:4px;font-size:10px;">APPENA ENTRATO</span>');
          if (threat) badges.push('<span style="background:#5c1f28;color:#f7768e;padding:2px 6px;border-radius:4px;font-size:10px;">MINACCIA</span>');
          if (p.isAdmin) badges.push('<span style="background:#313b66;color:#cdd6f4;padding:2px 6px;border-radius:4px;font-size:10px;">ADMIN</span>');
          const reliabilityColor = p.reliability >= 70 ? '#9ece6a' : (p.reliability >= 40 ? '#e0af68' : '#f7768e');
          const card = document.createElement('div');
          card.className = 'player-card';
          card.style.border = '1px solid #1e253f';
          card.style.background = '#11152a';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <div style="display:flex;align-items:center;gap:6px;">
                <span class="id" style="background:#132341;">#${p.id}</span>
                <strong style="font-size:13px;">${p.name||''}</strong>
              </div>
              <div style="font-size:11px;color:${p.ping>120?'#f7768e':p.ping>70?'#e0af68':'#9ece6a'};font-weight:600;">${p.ping||0}ms</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:4px;">${badges.join(' ')}</div>
            <div style="font-size:11px;color:#7986a8;display:flex;justify-content:space-between;">
              <span>Giocato: ${hours}h ${mins}m</span>
              <span style="color:${reliabilityColor};">Affidabilità ${p.reliability}%</span>
            </div>
            <div style="margin-top:6px;margin-bottom:4px;height:6px;background:#1e253f;border-radius:4px;overflow:hidden;position:relative;">
              <div style="width:${health}%;height:100%;background:${healthColor};transition:width .3s;"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:10px;color:#6e7d99;">
              <span>Salute ${health}%</span>
              <span>Ban: ${p.banCount}</span>
            </div>
          `;
          card.style.cursor = 'pointer';
          card.addEventListener('click', ()=> openPlayerDetail(p));
          container.appendChild(card);
        });
        if (!container.hasChildNodes()) {
          container.innerHTML = '<p style="color:#7986a8;">Nessun giocatore trovato</p>';
        }
        // TODO: aggiungere controlli UI per cambiare pagina (pulsanti avanti/indietro)
      }

      // ------- Modali Azioni Giocatore -------
      let currentDetailPlayer = null;
      function openPlayerDetail(p){
        currentDetailPlayer = p;
        const modal = document.getElementById('playerDetailModal');
        if(!modal) return;
        document.getElementById('pdName').textContent = p.name||'';
        document.getElementById('pdNameVal').textContent = p.name||'';
        document.getElementById('pdId').textContent = '#' + (p.id||'');
        const status = (p.health!==undefined && p.health<=0)?'MORTO':'VIVO';
        document.getElementById('pdStatus').innerHTML = status === 'VIVO' ? '<span style="color:#9ece6a">VIVO</span>' : '<span style="color:#f7768e">MORTO</span>';
        const mins = p.minutesOnline || 0; const hrs = Math.floor(mins/60); const rm = mins%60;
        document.getElementById('pdOnlineTime').textContent = `${hrs}h ${rm}m`;
        document.getElementById('pdPlayTotal').textContent = `${hrs}h ${rm}m`; // se avessi playMinutes totali li userei
        document.getElementById('pdReliability').innerHTML = `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${p.reliability>=70?'#9ece6a':p.reliability>=40?'#e0af68':'#f7768e'}"></span> ${p.reliability||0}/100`;
        const ipEl = document.getElementById('pdIP');
        if (ipEl) {
          if (p.ipHidden) ipEl.innerHTML = '<span style="color:#e0af68;">Nascosto (staff)</span>'; else ipEl.textContent = p.ip || '-';
        }
        modal.style.display = 'flex';
      }
      function hideModal(id){ const m=document.getElementById(id); if(m) m.style.display='none'; }
      document.addEventListener('click', (e)=>{
        const closeAttr = e.target.getAttribute && e.target.getAttribute('data-close');
        if(closeAttr){ hideModal(closeAttr); }
      });
      document.getElementById('closePlayerDetail').addEventListener('click', ()=> hideModal('playerDetailModal'));
      document.getElementById('pdOpenSearch').addEventListener('click', ()=> {
        if(!currentDetailPlayer) return; hideModal('playerDetailModal');
        document.querySelectorAll('#nav-list li').forEach(li=>{ li.classList.remove('active'); if(li.getAttribute('data-section')==='search') li.classList.add('active'); });
        document.querySelectorAll('.section').forEach(sec=>sec.id==='search'?sec.classList.add('active'):sec.classList.remove('active'));
        const s=document.getElementById('searchInput'); if(s){ s.value=currentDetailPlayer.name||''; renderSearch(); }
      });
      // Azioni principali nel dettaglio
      function ensurePlayer(){ if(!currentDetailPlayer){ alert('Nessun giocatore selezionato'); return false;} return true; }
      document.getElementById('btnKick').addEventListener('click', ()=>{ if(!ensurePlayer())return; hideModal('playerDetailModal'); openKickModal(); });
      document.getElementById('btnBan').addEventListener('click', ()=>{ if(!ensurePlayer())return; hideModal('playerDetailModal'); openBanModal(); });
      document.getElementById('btnScreenshot').addEventListener('click', ()=>{ if(!ensurePlayer())return; hideModal('playerDetailModal'); openScreenshotModal(); });
      document.getElementById('btnSpectate').addEventListener('click', ()=>{ if(!ensurePlayer())return; hideModal('playerDetailModal'); openSpectateModal(); });

      // Kick Modal
      function openKickModal(){ const m=document.getElementById('kickModal'); if(!m)return; document.getElementById('kickTitle').textContent = 'Espelli - ' + (currentDetailPlayer.name||''); document.getElementById('kickReason').value=''; document.getElementById('kickFeedback').textContent=''; m.style.display='flex'; }
      document.getElementById('kickConfirm').addEventListener('click', ()=>{
        if(!ensurePlayer())return; const reason=document.getElementById('kickReason').value.trim();
        fetch(`https://${GetParentResourceName()}/kickPlayer`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:currentDetailPlayer.id,reason})});
        document.getElementById('kickFeedback').textContent='Richiesta kick inviata...'; setTimeout(()=> hideModal('kickModal'),800);
      });
      // Ban Modal
      function openBanModal(){ const m=document.getElementById('banModal'); if(!m)return; document.getElementById('banTitle').textContent='Banna - '+(currentDetailPlayer.name||''); document.getElementById('banReason').value=''; document.getElementById('banFeedback').textContent=''; m.style.display='flex'; }
      document.getElementById('banConfirm').addEventListener('click', ()=>{
        if(!ensurePlayer())return; const reason=document.getElementById('banReason').value.trim(); if(!reason){ document.getElementById('banFeedback').textContent='Inserisci un motivo'; return; }
        fetch(`https://${GetParentResourceName()}/banPlayer`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:currentDetailPlayer.id,reason,permanent:document.getElementById('banPermanent').checked})});
        document.getElementById('banFeedback').textContent='Richiesta ban inviata...'; setTimeout(()=> hideModal('banModal'),900);
      });
      // Screenshot Modal
      function openScreenshotModal(){ const m=document.getElementById('screenshotModal'); if(!m)return; document.getElementById('screenshotTitle').textContent='Screenshot - '+(currentDetailPlayer.name||''); document.getElementById('screenshotFeedback').textContent=''; m.style.display='flex'; }
      document.getElementById('screenshotConfirm').addEventListener('click', ()=>{
        if(!ensurePlayer())return; fetch(`https://${GetParentResourceName()}/screenshotPlayer`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:currentDetailPlayer.id})});
        document.getElementById('screenshotFeedback').textContent='Richiesta screenshot inviata...'; setTimeout(()=> hideModal('screenshotModal'),900);
      });
      // Spectate Modal
      function openSpectateModal(){ const m=document.getElementById('spectateModal'); if(!m)return; document.getElementById('spectateTitle').textContent='Osserva - '+(currentDetailPlayer.name||''); m.style.display='flex'; spectateStart(); }
      function spectateStart(){ if(!currentDetailPlayer)return; fetch(`https://${GetParentResourceName()}/spectatePlayer`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:currentDetailPlayer.id,disableHud:document.getElementById('spectateHudToggle').checked})}); document.getElementById('spectateFeedback').textContent='Modalità osservazione avviata (in gioco)'; }
      function spectateStop(){ fetch(`https://${GetParentResourceName()}/spectateStop`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})}); document.getElementById('spectateFeedback').textContent='Osservazione terminata'; }
      document.getElementById('spectateStop').addEventListener('click', ()=> { spectateStop(); hideModal('spectateModal'); });
      document.getElementById('spectateShot').addEventListener('click', ()=> { if(!currentDetailPlayer)return; fetch(`https://${GetParentResourceName()}/screenshotPlayer`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:currentDetailPlayer.id,tag:'spectate'})}); });
      document.getElementById('spectateClose').addEventListener('click', ()=> { spectateStop(); });
      document.getElementById('spectateHudToggle').addEventListener('change', ()=> { /* opzionale: inviare aggiornamento */ });

      const PERMISSION_DEFS = [
        {key:'all', label:'Tutte le autorizzazioni'},
        {key:'config', label:'Configurazione'},
        {key:'download', label:'Scaricare file'},
        {key:'manage_admins', label:'Gestire admins'},
        {key:'bypass', label:'Bypass anti-cheat'},
        {key:'kick', label:'Espellere giocatori'},
        {key:'bans', label:'Gestire ban'},
        {key:'logs', label:'Visualizzare log'},
        {key:'console', label:'Visualizzare console'},
        {key:'commands', label:'Eseguire comandi'},
        {key:'search', label:'Ricerca giocatori'}
      ];
      function hasPerm(p){
        if(!serverData.you||!serverData.you.perms) return false; const perms=serverData.you.perms; if(perms.includes('all')) return true; return perms.includes(p);
      }
      function ensurePermFilterOptions(){
        const sel=document.getElementById('permFilter'); if(!sel||sel.options.length>1) return; PERMISSION_DEFS.forEach(p=>{ if(p.key==='all') return; const o=document.createElement('option'); o.value=p.key; o.textContent=p.label; sel.appendChild(o); });
      }
      function renderAdmins(){
        ensurePermFilterOptions();
        const tbody=document.getElementById('adminsTableBody'); if(!tbody) return; const adminsMeta=document.getElementById('adminsMeta');
        const search=(document.getElementById('adminsSearch')?.value||'').toLowerCase();
        const filter=document.getElementById('permFilter')?.value||'';
        tbody.innerHTML='';
        const adminsObj=serverData.admins||{}; const rows=[]; let count=0;
        for(const identifier in adminsObj){ const a=adminsObj[identifier]; const name=a.name||identifier.slice(-6); const discord=a.discord||''; const perms=a.perms||[]; if(search){ const hay=(name+' '+discord+' '+perms.join(' ')).toLowerCase(); if(!hay.includes(search)) continue; } if(filter){ if(!perms.includes(filter) && !perms.includes('all')) continue; }
          count++; const chips = (perms[0]==='all'?['Tutte'] : perms.map(pk=>{ const def=PERMISSION_DEFS.find(d=>d.key===pk); return def?def.label:pk; })).slice(0,3).map(c=>`<span style="background:#132341;border:1px solid #1e253f;color:#7aa2f7;padding:2px 6px;border-radius:12px;font-size:10px;">${c}</span>`).join(' ')+(perms.length>3?` <span style="background:#132341;border:1px solid #1e253f;color:#7aa2f7;padding:2px 6px;border-radius:12px;font-size:10px;">+${perms.length-3}</span>`:'');
          const added = a.addedAt ? formatDate(new Date(a.addedAt*1000).toISOString()) : '-';
          const row=document.createElement('tr');
          row.innerHTML = `
            <td style="display:flex;align-items:center;gap:10px;">
              <div style="width:34px;height:34px;border-radius:50%;background:#132341;display:flex;align-items:center;justify-content:center;font-size:13px;color:#7aa2f7;font-weight:600;">${(name||'?').substring(0,2).toUpperCase()}</div>
              <div style="display:flex;flex-direction:column;">
                <span style="color:#cdd6f4;font-weight:500;">${name}</span>
                <span style="font-size:11px;color:#7986a8;">${identifier.slice(-12)}</span>
              </div>
            </td>
            <td style="font-size:12px;">${discord?discord:'-'}</td>
            <td>${chips}</td>
            <td style="font-size:12px;">${added}</td>
            <td style="text-align:center;">
              ${(hasPerm('manage_admins') && !perms.includes('all'))?`<button class="admEdit" data-id="${identifier}" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:4px 8px;border-radius:6px;font-size:11px;cursor:pointer;">⋯</button>`:'Protetto'}
            </td>`;
          tbody.appendChild(row);
        }
        if(adminsMeta) adminsMeta.textContent = count+ (count===1?' admin trovato':' admins trovati');
        if(count===0){ tbody.innerHTML='<tr><td colspan="5" style="text-align:center;color:#7986a8;">Nessun admin trovato</td></tr>'; }
      }
      function buildAddAdminModal(){
        const sel=document.getElementById('aaPlayer'); if(sel){ sel.innerHTML=''; const opt=document.createElement('option'); opt.value=''; opt.textContent='Seleziona giocatore…'; sel.appendChild(opt); (serverData.players||[]).forEach(p=>{ if(!p.isAdmin){ const o=document.createElement('option'); o.value=p.license||p.identifier||p.name; o.textContent=p.name+' ('+(p.license||p.identifier||'')+')'; sel.appendChild(o);} }); }
        const permsWrap=document.getElementById('aaPerms'); if(permsWrap && permsWrap.childElementCount===0){ PERMISSION_DEFS.forEach(def=>{ const id='perm_'+def.key; const div=document.createElement('label'); div.style.cssText='display:flex;align-items:center;gap:6px;font-size:12px;color:#cdd6f4;'; div.innerHTML=`<input type="checkbox" id="${id}" value="${def.key}" style="accent-color:#7aa2f7;" ${def.key==='all'?'checked':''}/> ${def.label}`; permsWrap.appendChild(div); }); }
      }
      function openAddAdmin(){ buildAddAdminModal(); document.getElementById('addAdminModal').style.display='flex'; }
      function closeAddAdmin(){ document.getElementById('addAdminModal').style.display='none'; }
          const bannedAt = (b.bannedAt ? new Date(b.bannedAt*1000) : (b.created_at ? new Date(b.created_at) : new Date()));
          const bannedBy = b.bannedBy || b.banned_by || 'Sistema';
          const expiresAt = (b.expiresAt ? new Date(b.expiresAt*1000) : null);
          const permanent = b.permanent === true || !expiresAt;
          let statusLabel = 'Permanente';
          if (!permanent && expiresAt) {
            const diff = expiresAt.getTime() - Date.now();
            if (diff <= 0) statusLabel = 'Scaduto'; else {
              const days = Math.floor(diff / 86400000);
              if (days >= 1) statusLabel = `Scade tra ${days}g`; else {
                const hours = Math.floor(diff / 3600000);
                statusLabel = `Scade tra ${hours}h`;
              }
            }
          }
          const evidence = b.evidence ? `<button class="evidence" data-evidence="${encodeURIComponent(b.evidence)}" title="Mostra evidenza" style="background:#132341;border:1px solid #1e253f;color:#7aa2f7;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px;">▶</button>` : '<span style="color:#48526b;font-size:11px;">Nessuna</span>';
          const statusChip = `<span style="display:inline-block;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;background:${permanent?'#3a1d29':'#132341'};color:${permanent?'#f7768e':'#7aa2f7'};">${statusLabel}</span>`;
          const dateStr = bannedAt.toLocaleDateString('it-IT',{day:'2-digit',month:'short',year:'numeric'})+'<br>'+bannedAt.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
          tr.innerHTML = `
            <td><div style="display:flex;flex-direction:column;gap:2px;">${playerName}<span style="font-size:11px;color:#6e7d99;">Giocatore</span></div></td>
            <td><span style="background:#313b66;color:#cdd6f4;padding:3px 6px;border-radius:6px;font-size:11px;">#${banId}</span></td>
            <td>${reason}</td>
            <td style="text-align:center;">${evidence}</td>
            <td>${statusChip}</td>
            <td>${dateStr}</td>
            <td style="display:flex;gap:6px;justify-content:center;">
              <button class="banView" data-banid="${banId}" data-identifier="${b.identifier}" style="background:#132341;border:1px solid #1e253f;color:#cdd6f4;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px;">👁️</button>
              <button class="banUnban" data-identifier="${b.identifier}" style="background:#5c1f28;border:1px solid #813947;color:#f7768e;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px;">✖</button>
            </td>`;
          tbody.appendChild(tr);
        });
        if (counter) counter.textContent = filtered.length+` ban trovati`;
        if (!filtered.length) tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#7986a8;">Nessun ban trovato</td></tr>';
        // azioni
        tbody.querySelectorAll('.banUnban').forEach(btn=>{
          btn.addEventListener('click',()=>{
            fetch(`https://${GetParentResourceName()}/unbanPlayer`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({identifier:btn.dataset.identifier})});
          });
        });
        tbody.querySelectorAll('.banView').forEach(btn=>{
          btn.addEventListener('click',()=>openBanDetail(btn.dataset.identifier));
        });
      }

      function openBanDetail(identifier){
        const modal=document.getElementById('banDetailModal'); if(!modal)return; const bans=serverData.bans||{}; const ban = Array.isArray(bans) ? bans.find(b=>b.identifier===identifier) : bans[identifier]; if(!ban){return;}
        document.getElementById('bdId').textContent = '#' + (ban.banId || identifier.slice(-6));
        document.getElementById('bdReason').textContent = ban.reason || '-';
  const bAt = ban.bannedAt ? new Date(ban.bannedAt*1000) : new Date();
  document.getElementById('bdDate').innerHTML = formatDate((ban.bannedAt ? new Date(ban.bannedAt*1000).toISOString() : new Date().toISOString()));
        document.getElementById('bdPlayer').textContent = ban.playerName || ban.player || 'Sconosciuto';
        document.getElementById('bdBy').textContent = ban.bannedBy || ban.banned_by || 'Sistema';
        let expireTxt = 'Permanente';
        if (ban.expiresAt) {
          const expDate = new Date(ban.expiresAt*1000);
          const diff = expDate.getTime() - Date.now();
          if (diff <= 0) expireTxt = 'Scaduto'; else {
            const days = Math.floor(diff/86400000); const hours = Math.floor((diff%86400000)/3600000); expireTxt = days>0?`Tra ${days}g ${hours}h`:`Tra ${hours}h`;
          }
        }
        document.getElementById('bdExpire').textContent = expireTxt;
        if (ban.evidence) { document.getElementById('bdEvidence').textContent = ban.evidence; document.getElementById('bdEvidenceWrap').style.display='block'; } else { document.getElementById('bdEvidenceWrap').style.display='none'; }
        document.getElementById('bdUnban').onclick = function(){ fetch(`https://${GetParentResourceName()}/unbanPlayer`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({identifier:identifier})}); };
        modal.style.display='flex';
      }

      function renderAdmins() {
        const tbody = document.getElementById('adminsTableBody');
        if (!tbody) return;
        const search = document.getElementById('adminsSearch').value.toLowerCase();
        tbody.innerHTML = '';
        const list = serverData.players ? serverData.players.filter(p => p.isAdmin) : [];
        list.forEach((player, idx) => {
          const name = player.name || '';
          const discord = player.discord || '';
          const match = name.toLowerCase().includes(search) || discord.toLowerCase().includes(search);
          if (!match) return;
          const row = document.createElement('tr');
          const perms = 'Gestione ban, Configurazione';
          const roleTag = `<span style="background:#313b66;color:#cdd6f4;padding:2px 4px;border-radius:4px;font-size:10px;">Admin</span>`;
          row.innerHTML = `
            <td>${name} ${roleTag}</td>
            <td>${discord || '-'}</td>
            <td>${perms}</td>
            <td>N/A</td>
            <td>Protetto</td>
          `;
          tbody.appendChild(row);
        });
        if (!tbody.hasChildNodes()) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#7986a8;">Nessun amministratore trovato</td></tr>';
        }
      }

      function renderLogs(){
        const tbody=document.getElementById('logsTableBody'); if(!tbody) return;
        const search=(document.getElementById('logsSearch')?.value||'').toLowerCase();
        const fromVal=document.getElementById('logFrom')?.value; const toVal=document.getElementById('logTo')?.value;
        const fromDate=fromVal?new Date(fromVal+'T00:00:00'):null; const toDate=toVal?new Date(toVal+'T23:59:59'):null;
        const activeRange=document.querySelector('.log-range-btn.active'); let minDate=null; if(activeRange){const r=activeRange.getAttribute('data-range'); const now=new Date(); if(r==='today') minDate=new Date(now.getFullYear(),now.getMonth(),now.getDate()); else if(r==='7d') minDate=new Date(now.getTime()-7*86400000); else if(r==='30d') minDate=new Date(now.getTime()-30*86400000);}        
        const activeChips=Array.from(document.querySelectorAll('.log-chip.log-chip-on')).map(c=>c.getAttribute('data-chip'));
        const filtered=logs.filter(l=>{ const d=new Date(l.time); if(minDate&&d<minDate) return false; if(fromDate&&d<fromDate) return false; if(toDate&&d>toDate) return false; const cat=getEventCategory(l.type); if(activeChips.length && !activeChips.includes(cat)) return false; if(search){ const hay=`${l.player||''} ${l.details||''} ${l.type||''} ${l.member||''}`.toLowerCase(); if(!hay.includes(search)) return false; } return true; });
        filtered.sort((a,b)=> new Date(b.time)-new Date(a.time));
        tbody.innerHTML='';
        filtered.forEach(l=>{ const d=new Date(l.time); const timeStr=d.toTimeString().substring(0,8); const dateStr=d.getDate().toString().padStart(2,'0')+' '+['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'][d.getMonth()]; const label=getLogTypeLabel(l.type); const tr=document.createElement('tr'); tr.innerHTML=`<td>${timeStr}<br>${dateStr}</td><td><span style=\"background:${label.color};color:#0a0d1e;padding:2px 4px;border-radius:4px;font-size:10px;\">${label.text}</span></td><td>${l.player||'-'}</td><td>${l.details||'-'}</td><td>${l.member||'-'}</td>`; tbody.appendChild(tr); });
        if(!tbody.hasChildNodes()) tbody.innerHTML='<tr><td colspan="5" style="text-align:center;color:#7986a8;">Nessun log trovato</td></tr>';
        const meta=document.getElementById('logsMeta'); if(meta) meta.textContent=`${filtered.length} eventi visualizzati`;
        drawStackedAreaChart(filtered); updateEventLegend(filtered);
      }

      function renderConsole() {
        const container = document.getElementById('console-log');
        if (!container) return;
        const search = document.getElementById('consoleSearch').value.toLowerCase();
        let lines = consoleLogs;
        if (search) {
          lines = consoleLogs.filter(l => l.toLowerCase().includes(search));
        }
        // Evidenzia termini di ricerca
        const highlight = (line) => {
          if (!search) return line;
          const regex = new RegExp(search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
          return line.replace(regex, match => `<span style="background:#313b66;color:#cdd6f4;">${match}</span>`);
        };
        container.innerHTML = lines.map(l => highlight(l)).join('\n');
        container.scrollTop = container.scrollHeight;
      }

      let analysisPeriod = 'today';
      function setAnalysisPeriod(p) { analysisPeriod = p; renderAnalysis(); }
      function renderAnalysis() {
        const tbody = document.getElementById('analysisTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const all = serverData.samples || [];
        const now = new Date();
        let fromTime = null;
        if (analysisPeriod === 'today') {
          fromTime = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        } else if (analysisPeriod === '7d') {
          fromTime = now.getTime() - 7*24*60*60*1000;
        } else if (analysisPeriod === '30d') {
          fromTime = now.getTime() - 30*24*60*60*1000;
        }
        let filtered = all.filter(s => {
          if (!s.time) return false;
          const t = new Date(s.time).getTime();
          return !fromTime || t >= fromTime;
        });
        // Aggregazione oraria per periodi lunghi
        let displaySamples = filtered;
        if (analysisPeriod === '7d' || analysisPeriod === '30d') {
          const buckets = {};
          filtered.forEach(s => {
            const d = new Date(s.time);
            const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}`;
            if (!buckets[key]) {
              buckets[key] = { time: new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours()).toISOString(), players:0, bans:0, peak:0, avg:0, count:0 };
            }
            const b = buckets[key];
            b.players += (s.players||0);
            b.bans = s.bans || b.bans; // usa ultimo valore cumulativo
            b.peak = Math.max(b.peak, s.peak||0);
            b.avg += (s.avg||0);
            b.count++;
          });
          displaySamples = Object.values(buckets).sort((a,b)=> new Date(a.time)-new Date(b.time));
          displaySamples.forEach(b => { b.players = Math.round(b.players / (b.count||1)); b.avg = Math.round(b.avg / (b.count||1)); });
        }
        // Statistiche riepilogo per periodo
        let selectedPeak = 0; let bansStart = null; let bansEnd = null;
        displaySamples.forEach(s => {
          if (s.peak && s.peak > selectedPeak) selectedPeak = s.peak;
          if (bansStart === null) bansStart = s.bans || 0;
          bansEnd = s.bans || bansEnd;
        });
        const blockedDelta = (bansEnd !== null && bansStart !== null) ? Math.max(0, bansEnd - bansStart) : 0;
  // Aggiorna metriche card
  const currentPlayers = (displaySamples.length>0 ? (displaySamples[displaySamples.length-1].players||0) : (serverData.playersOnline||0));
  const maxPlayers = (serverData.server && serverData.server.maxPlayers) ? serverData.server.maxPlayers : 0;
  const totalBans = (displaySamples.length>0 ? (displaySamples[displaySamples.length-1].bans||0) : (serverData.totalBans||0));
  const avgPlayersPeriod = displaySamples.length>0 ? Math.round(displaySamples.reduce((a,s)=>a+(s.players||0),0)/displaySamples.length) : 0;
  const peakSpan = document.getElementById('analysisPeakPlayers'); if (peakSpan) peakSpan.textContent = selectedPeak;
  const bannedSpan = document.getElementById('analysisBannedPlayers'); if (bannedSpan) bannedSpan.textContent = totalBans;
  const currSpan = document.getElementById('analysisCurrentPlayers'); if (currSpan) currSpan.textContent = currentPlayers;
  const slotSpan = document.getElementById('analysisCurrentPlayersSlots'); if (slotSpan) slotSpan.textContent = `${currentPlayers} / ${maxPlayers}`;
  const avgSpan = document.getElementById('analysisAvgPlayers'); if (avgSpan) avgSpan.textContent = avgPlayersPeriod;
  const peakLabel = document.getElementById('analysisPeakLabel'); if (peakLabel) peakLabel.textContent = '(' + (analysisPeriod === 'today' ? 'oggi' : analysisPeriod === '7d' ? 'ultimi 7g' : 'ultimi 30g') + ')';
  const avgLabel = document.getElementById('analysisAvgLabel'); if (avgLabel) avgLabel.textContent = '(' + (analysisPeriod === 'today' ? 'oggi' : analysisPeriod === '7d' ? 'ultimi 7g' : 'ultimi 30g') + ')';
        // Tabella (limita per performance)
        const maxRows = 500;
        const tableSamples = displaySamples.slice(-maxRows);
        tableSamples.forEach(s => {
          const tr = document.createElement('tr');
            const date = new Date(s.time || Date.now());
          const hh = String(date.getHours()).padStart(2,'0');
          const mm = String(date.getMinutes()).padStart(2,'0');
          const dayPart = (analysisPeriod === 'today') ? '' : `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')} `;
          tr.innerHTML = `<td>${dayPart}${hh}:${mm}</td><td>${s.players||0}</td><td>${s.bans||0}</td><td>${s.peak||0}</td><td>${s.avg||0}</td>`;
          tbody.appendChild(tr);
        });
        if (!tbody.hasChildNodes()) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#7986a8;">Nessun dato</td></tr>';
        }
        if (window.analysisChart) {
          const labels = []; const dataPlayers = []; const dataBans = [];
          displaySamples.forEach(s => {
            const d = new Date(s.time);
            let label;
            if (analysisPeriod === 'today') label = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            else label = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:00`;
            labels.push(label); dataPlayers.push(s.players||0); dataBans.push(s.bans||0);
          });
          window.analysisChart.data.labels = labels;
          window.analysisChart.data.datasets[0].data = dataPlayers;
          window.analysisChart.data.datasets[1].data = dataBans;
          window.analysisChart.update('none');
        }
      }
      function exportSamplesCSV() {
        const samples = serverData.samples || [];
        let csv = 'time,players,bans,peak,avg\n';
        samples.forEach(s => { csv += `${s.time},${s.players||0},${s.bans||0},${s.peak||0},${s.avg||0}\n`; });
        const blob = new Blob([csv], { type:'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'samples.csv'; a.click(); URL.revokeObjectURL(url);
      }

      function renderConfigCategory(cat){
        const wrap = document.getElementById('config-content');
        if(!wrap) return;
        const data = (configData[cat] && configData[cat].groups) ? configData[cat].groups : [];
        wrap.innerHTML='';
        data.forEach(group=>{
          const card = document.createElement('div');
          card.style.background='#0d1324';
          card.style.border='1px solid #1e253f';
          card.style.borderRadius='10px';
          card.style.padding='16px 18px 14px';
          card.style.marginBottom='18px';
          const title = document.createElement('h3');
          title.textContent=group.title; title.style.margin='0 0 10px 0'; title.style.fontSize='15px'; title.style.color='#cdd6f4';
          card.appendChild(title);
          group.items.forEach(item=>{
            const row = document.createElement('div');
            row.style.display='flex';
            row.style.alignItems='center';
            row.style.justifyContent='space-between';
            row.style.padding='6px 0';
            row.style.borderBottom='1px solid #111a2f';
            const label = document.createElement('div');
            label.textContent = item.label; label.style.fontSize='13px'; label.style.color='#a6adc8'; label.style.flex='1';
            row.appendChild(label);
            const control = document.createElement('div');
            if(item.type==='toggle'){
              const tLabel=document.createElement('label'); tLabel.className='toggle';
              const input=document.createElement('input'); input.type='checkbox'; input.checked=!!item.value;
              input.addEventListener('change', ()=>{ item.value=input.checked; sendConfigUpdate(); });
              const span=document.createElement('span'); span.className='slider'; tLabel.appendChild(input); tLabel.appendChild(span); control.appendChild(tLabel);
            } else if(item.type==='number'){
              const inp=document.createElement('input'); inp.type='number'; inp.value=item.value; inp.style.width='110px'; inp.style.background='#0a1020'; inp.style.border='1px solid #1e253f'; inp.style.color='#cdd6f4'; inp.style.borderRadius='6px'; inp.style.padding='4px 6px'; inp.addEventListener('change',()=>{ item.value=parseInt(inp.value)||0; sendConfigUpdate(); }); control.appendChild(inp);
            } else if(item.type==='text'){
              const inp=document.createElement('input'); inp.type='text'; inp.value=item.value||''; inp.placeholder=item.label; inp.style.minWidth='240px'; inp.style.background='#0a1020'; inp.style.border='1px solid #1e253f'; inp.style.color='#cdd6f4'; inp.style.borderRadius='6px'; inp.style.padding='4px 8px'; inp.addEventListener('input',()=>{ item.value=inp.value; sendConfigUpdate(); }); control.appendChild(inp);
            } else if(item.type==='tags'){
              const wrapper=document.createElement('div'); wrapper.style.display='flex'; wrapper.style.flexDirection='column'; wrapper.style.alignItems='flex-end'; wrapper.style.gap='6px';
              const tagsBox=document.createElement('div'); tagsBox.style.display='flex'; tagsBox.style.flexWrap='wrap'; tagsBox.style.maxWidth='380px'; tagsBox.style.gap='4px';
              const renderTags=()=>{ tagsBox.innerHTML=''; (item.value||[]).forEach((tag,i)=>{ const chip=document.createElement('span'); chip.textContent=tag+' ×'; chip.style.background='#132341'; chip.style.color='#cdd6f4'; chip.style.fontSize='11px'; chip.style.padding='4px 6px'; chip.style.border='1px solid #1e253f'; chip.style.borderRadius='6px'; chip.style.cursor='pointer'; chip.addEventListener('click',()=>{ item.value.splice(i,1); renderTags(); sendConfigUpdate(); }); tagsBox.appendChild(chip); }); if((item.value||[]).length===0){ const empty=document.createElement('span'); empty.textContent='No items added'; empty.style.fontSize='11px'; empty.style.color='#54607b'; tagsBox.appendChild(empty);} };
              renderTags();
              const inputWrap=document.createElement('div'); inputWrap.style.display='flex'; inputWrap.style.gap='6px';
              const inp=document.createElement('input'); inp.type='text'; inp.placeholder=item.label; inp.style.background='#0a1020'; inp.style.border='1px solid #1e253f'; inp.style.color='#cdd6f4'; inp.style.borderRadius='6px'; inp.style.padding='4px 8px'; inp.style.minWidth='220px';
              const addBtn=document.createElement('button'); addBtn.textContent='Add'; addBtn.style.background='#132341'; addBtn.style.color='#cdd6f4'; addBtn.style.border='1px solid #1e253f'; addBtn.style.borderRadius='6px'; addBtn.style.cursor='pointer'; addBtn.style.fontSize='12px'; addBtn.addEventListener('click',()=>{ const v=inp.value.trim(); if(v.length>0){ if(!Array.isArray(item.value)) item.value=[]; item.value.push(v); inp.value=''; renderTags(); sendConfigUpdate(); }});
              const clearBtn=document.createElement('button'); clearBtn.textContent='Clear All'; clearBtn.style.background='#132341'; clearBtn.style.color='#cdd6f4'; clearBtn.style.border='1px solid #1e253f'; clearBtn.style.borderRadius='6px'; clearBtn.style.cursor='pointer'; clearBtn.style.fontSize='12px'; clearBtn.addEventListener('click',()=>{ item.value=[]; renderTags(); sendConfigUpdate(); });
              inputWrap.appendChild(inp); inputWrap.appendChild(addBtn); inputWrap.appendChild(clearBtn);
              wrapper.appendChild(inputWrap); wrapper.appendChild(tagsBox); control.appendChild(wrapper);
            }
            row.appendChild(control); card.appendChild(row);
          });
          wrap.appendChild(card);
        });
        if(data.length===0) wrap.innerHTML='<p style="color:#7986a8;">Nessuna configurazione.</p>';
      }

      // Disegna la mappa interattiva dei giocatori utilizzando posizioni casuali basate sull'ID
      function renderMap() {
        const container = document.getElementById('mapContainer');
        if (!container) return;
        container.innerHTML = '';
        const width = container.clientWidth;
        const height = container.clientHeight;
        // Usa i dati reali del server (serverData.players) se disponibili. La mappa non è utilizzata
        // ma manteniamo la funzione per compatibilità futura.
        const list = serverData.players || [];
        list.forEach(p => {
          const div = document.createElement('div');
          // Genera coordinate pseudo-casuali basate sull'ID e sui minuti di gioco
          const x = ((p.id % 100) / 100) * (width - 20) + 10;
          const y = ((p.playMinutes % 100) / 100) * (height - 20) + 10;
          div.style.position = 'absolute';
          div.style.left = x + 'px';
          div.style.top = y + 'px';
          div.style.width = '10px';
          div.style.height = '10px';
          div.style.borderRadius = '50%';
          div.style.background = p.threat ? '#f7768e' : '#7aa2f7';
          div.title = `${p.name} (ID ${p.id})`;
          container.appendChild(div);
        });
      }

      // Visualizza la sezione multi-stream con un pulsante di apertura stream per ciascun giocatore
      function renderMulti() {
        const container = document.getElementById('multiContainer');
        if (!container) return;
        container.innerHTML = '';
        const list = serverData.players || [];
        list.forEach(p => {
          const joinMinutes = p.joinMinutes || 0;
          const playMinutes = p.playMinutes || 0;
          const health = p.health !== undefined ? p.health : 100;
          const card = document.createElement('div');
          card.className = 'player-card';
          card.innerHTML = `
            <div class="header">
              <span class="id">#${p.id}</span>
              <span class="ping">${p.ping || 0}ms</span>
            </div>
            <div class="name">${p.name || ''}</div>
            <div class="joined">Entrato ${Math.floor(joinMinutes / 60)}h ${joinMinutes % 60}m fa</div>
            <div class="bar">
              <div style="width:${health}%;background:${health <= 40 ? '#f7768e' : health <= 70 ? '#e0af68' : '#9ece6a'};"></div>
            </div>
            <small>Giocato per ${formatMinutes(playMinutes)}</small>
            <button style="margin-top:8px;background:#313b66;color:#cdd6f4;border:none;padding:6px 8px;border-radius:6px;cursor:pointer;">Apri stream</button>
          `;
          // Gestore per il pulsante Apri stream
          card.querySelector('button').addEventListener('click', () => {
            // Integrazione streaming: invia richiesta NUI a Lua per aprire lo stream di questo giocatore
            fetch(`https://${GetParentResourceName()}/openPlayerStream`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: p.id, name: p.name })
            });
          });
          container.appendChild(card);
        });
      }
      function renderSearch() {
        const input = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('searchResults');
        if (!input || !resultsContainer) return;
        const query = input.value.trim().toLowerCase();
        resultsContainer.innerHTML = '';
        if (query.length < 2) {
          resultsContainer.innerHTML = '<p style="color:#7986a8;">Inserisci almeno 2 caratteri per cercare</p>';
          return;
        }
        const matches = (serverData.players || []).filter(p => {
          const name = (p.name || '').toLowerCase();
          const lic = (p.license || '').toLowerCase();
          const idStr = String(p.id || '').toLowerCase();
          return name.includes(query) || lic.includes(query) || idStr.includes(query);
        });
        if (matches.length === 0) {
          resultsContainer.innerHTML = '<p style="color:#7986a8;">Nessun giocatore trovato</p>';
          return;
        }
        matches.forEach(p => {
          const bansForPlayer = (serverData.bans || []).filter(b => ((b.player_name || b.player || '').toLowerCase() === (p.name || '').toLowerCase()));
          const banCount = bansForPlayer.length;
          const trust = Math.max(0, 100 - banCount * 20);
          const alt = findAltAccounts(p);
          // Costruisci card risultato
          const div = document.createElement('div');
          div.style.background = '#11152a';
          div.style.border = '1px solid #1e253f';
          div.style.borderRadius = '8px';
          div.style.padding = '12px';
          div.style.marginBottom = '10px';
          div.innerHTML = `
            <strong>${p.name}</strong> <span style="font-size:12px;color:#7986a8;">(ID: ${p.id})</span><br>
            <span style="font-size:12px;color:#7986a8;">Licenza: ${p.license}</span><br>
            <div style="margin-top:6px;">
              <div style="font-size:12px;color:#a6adc8;">Indice affidabilità: ${trust}%</div>
              <div style="background:#313b66;border-radius:4px;height:6px;overflow:hidden;margin-top:4px;">
                <div style="width:${trust}%;height:100%;background:${trust >= 70 ? '#9ece6a' : trust >= 40 ? '#e0af68' : '#f7768e'};"></div>
              </div>
            </div>
            <div style="margin-top:6px;font-size:12px;color:#a6adc8;">Bann totali: ${banCount}</div>
            ${banCount > 0 ? '<div style="margin-top:4px;font-size:12px;color:#a6adc8;"><strong>Storico ban:</strong><ul style="margin-left:16px;margin-top:2px;">' + bansForPlayer.map(b => `<li>${formatDate(b.created_at || b.bannedAt).replace('<br>', ' ')} – ${b.reason}</li>`).join('') + '</ul></div>' : ''}
            ${alt.length > 0 ? '<div style="margin-top:4px;font-size:12px;color:#a6adc8;"><strong>Possibili alt:</strong> ' + alt.join(', ') + '</div>' : ''}
          `;
          resultsContainer.appendChild(div);
        });
      }

      // ----------------------
      // Gestione menu e inizializzazione
      // ----------------------
      function initDashboard() {
        // Attiva navigation
        document.querySelectorAll('#nav-list li').forEach(function(item) {
          item.addEventListener('click', function() {
            document.querySelectorAll('#nav-list li').forEach(li => li.classList.remove('active'));
            this.classList.add('active');
            const target = this.getAttribute('data-section');
            document.querySelectorAll('.section').forEach(sec => {
              if (sec.id === target) sec.classList.add('active');
              else sec.classList.remove('active');
            });
            // quando cambiamo sezione, potremmo voler ridisegnare alcuni elementi
            if (target === 'players') renderPlayers();
            if (target === 'map') renderMap();
            if (target === 'multi') renderMulti();
            if (target === 'bans') renderBans();
            if (target === 'admins') renderAdmins();
            if (target === 'logs') renderLogs();
            if (target === 'config') renderConfigCategory(document.querySelector('.config-tabs button.active').getAttribute('data-tab'));
          });
        });
        // Calcola statistiche dashboard e aggiorna le card solo quando arrivano dati
        const stats = calculatePlayerStats();
        const dashboardCards = document.querySelectorAll('#dashboard .card');
        if (dashboardCards.length >= 8) {
          // Lascia i valori vuoti finché non arrivano dati; saranno aggiornati su messaggio 'show'
          dashboardCards[4].querySelector('.value').textContent = `${stats.current} / 0`;
          dashboardCards[5].querySelector('.value').textContent = `0`;
          dashboardCards[6].querySelector('.value').textContent = `${stats.peak}`;
          dashboardCards[7].querySelector('.value').textContent = `${stats.average}`;
        }
        // Imposta ascoltatori per le sezioni giocatori
        document.getElementById('playersSearch').addEventListener('input', renderPlayers);
        document.getElementById('filterNew').addEventListener('change', renderPlayers);
        document.getElementById('filterRecent').addEventListener('change', renderPlayers);
        document.getElementById('filterThreat').addEventListener('change', renderPlayers);
        // Inizializza bans: ascoltatori per ricerca e ordinamento
        document.getElementById('bansSearch').addEventListener('input', renderBans);
        document.getElementById('banSort').addEventListener('change', renderBans);
        document.getElementById('unbanAll').addEventListener('click', ()=>{ const m=document.getElementById('unbanAllModal'); if(m) m.style.display='flex'; });
        document.getElementById('unbanAllConfirm').addEventListener('click', ()=>{
          fetch(`https://${GetParentResourceName()}/unbanAll`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({}) });
          document.getElementById('unbanAllFeedback').textContent='Richiesta inviata...';
          setTimeout(()=>{ hideModal('unbanAllModal'); },900);
        });
        document.getElementById('banOffline').addEventListener('click', ()=>{ const m=document.getElementById('offlineBanModal'); if(m) m.style.display='flex'; });
        function durationToSeconds(val){
          switch(val){
            case '1h': return 3600; case '6h': return 21600; case '24h': return 86400; case '7d': return 7*86400; case '30d': return 30*86400; default: return null;
          }
        }
        document.getElementById('obSubmit').addEventListener('click', ()=>{
          const ident = document.getElementById('obIdentifier').value.trim();
          const reason = document.getElementById('obReason').value.trim();
          const evidence = document.getElementById('obEvidence').value.trim();
          const durationSel = document.getElementById('obDuration').value;
          if(!ident){ document.getElementById('obFeedback').textContent='Identificatore richiesto'; return; }
          if(!reason){ document.getElementById('obFeedback').textContent='Motivo richiesto'; return; }
            fetch(`https://${GetParentResourceName()}/banOffline`, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body:JSON.stringify({ identifier: ident, reason: reason, duration: durationToSeconds(durationSel), evidence: evidence||null })
            });
          document.getElementById('obFeedback').textContent='Ban inviato...';
          setTimeout(()=>{ hideModal('offlineBanModal'); },1100);
        });
        // Inizializza admins: ascoltatore per ricerca
        document.getElementById('adminsSearch').addEventListener('input', renderAdmins);
        const pf=document.getElementById('permFilter'); if(pf) pf.addEventListener('change', renderAdmins);
        const addBtn=document.getElementById('btnAddAdmin'); if(addBtn) addBtn.addEventListener('click', openAddAdmin);
        document.querySelectorAll('[data-close="addAdminModal"]').forEach(b=>b.addEventListener('click', closeAddAdmin));
        const aaSubmit=document.getElementById('aaSubmit'); if(aaSubmit) aaSubmit.addEventListener('click', ()=>{
          const sel=document.getElementById('aaPlayer'); const identifier=sel&&sel.value; if(!identifier){ document.getElementById('aaFeedback').textContent='Seleziona un giocatore'; return; }
          const perms=[]; document.querySelectorAll('#aaPerms input[type="checkbox"]:checked').forEach(cb=>{ perms.push(cb.value); });
          const nameOption = sel.options[sel.selectedIndex]; const nameTxt = nameOption? nameOption.textContent.split(' (')[0]:'';
          fetch(`https://${GetParentResourceName()}/addAdmin`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({identifier,perms,name:nameTxt})});
          document.getElementById('aaFeedback').textContent='Richiesta inviata...'; setTimeout(()=>{ closeAddAdmin(); },900);
        });
  // Inizializza logs: nuovi listener
  document.getElementById('logsSearch').addEventListener('input', renderLogs);
  document.getElementById('logFrom').addEventListener('change', renderLogs);
  document.getElementById('logTo').addEventListener('change', renderLogs);
  document.querySelectorAll('.log-range-btn').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('.log-range-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderLogs();}));
  document.querySelectorAll('.log-chip').forEach(ch=>ch.addEventListener('click',()=>{ch.classList.toggle('log-chip-on'); ch.style.color=ch.classList.contains('log-chip-on')?'#7aa2f7':'#6e7d99'; renderLogs();}));
        // Inizializza console: ascoltatore per ricerca, pulizia e download
        document.getElementById('consoleSearch').addEventListener('input', renderConsole);
        document.getElementById('consoleClear').addEventListener('click', function() {
          consoleLogs = [];
          renderConsole();
          renderAnalysis();
        });
        document.getElementById('consoleDownload').addEventListener('click', function() {
          const blob = new Blob([consoleLogs.join('\n')], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'console_log.txt';
          a.click();
          URL.revokeObjectURL(url);
        });
        // Inizializza configurazione: gestione tab
        document.querySelectorAll('.config-tabs button').forEach(btn => {
          btn.addEventListener('click', function() {
            document.querySelectorAll('.config-tabs button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const cat = this.getAttribute('data-tab');
            renderConfigCategory(cat);
          });
        });
        // Mostra categoria principale all'avvio
        renderConfigCategory('main');
        // Inizializza ricerca: ascoltatore
        document.getElementById('searchInput').addEventListener('input', renderSearch);
      }
      // Avvia inizializzazione quando il DOM è pronto
      document.addEventListener('DOMContentLoaded', initDashboard);

      

      // Nasconde l'interfaccia finché non vengono ricevuti dati dal lato client.
      document.addEventListener('DOMContentLoaded', function() {
        document.body.style.display = 'none';
      });

      // Aggiorna i valori delle carte del dashboard usando serverData.
      function updateDashboardCards() {
        const stats = calculatePlayerStats();
        const cards = document.querySelectorAll('#dashboard .card');
        if (cards.length >= 8) {
          // Giocatori attuali
          const totalSlots = serverData.slotCount || serverData.maxPlayers || 0;
          const curr = stats.current;
          cards[4].querySelector('.value').textContent = `${curr} / ${totalSlots}`;
          // Giocatori bannati
          const banCount = serverData.totalBans || (serverData.bans ? (Array.isArray(serverData.bans) ? serverData.bans.length : Object.keys(serverData.bans).length) : 0);
          cards[5].querySelector('.value').textContent = `${banCount}`;
          // Picco giocatori
          cards[6].querySelector('.value').textContent = `${stats.peak}`;
          // Media giocatori
          cards[7].querySelector('.value').textContent = `${stats.average}`;
        }
      }

      // Gestisce i messaggi provenienti dal client Lua. Mostra o nasconde l'interfaccia e aggiorna i dati.
      function applyDynamicCards() {
        const d = serverData;
        if (d.server) {
          document.getElementById('cardServerStatus').textContent = d.server.status || 'N/D';
          document.getElementById('cardServerName').textContent = d.server.name || '';
          document.getElementById('cardServerIP').textContent = d.server.ip || 'N/D';
          document.getElementById('cardServerPlayers').textContent = d.server.maxPlayers ? 'Slot' : '';
          const serverEntry = document.getElementById('serverEntry');
          if (serverEntry) serverEntry.textContent = d.server.name || 'Server';
          const fb = document.getElementById('footerBrand');
          if (fb) fb.textContent = (d.server.name || 'EmpireRP') + ' • Real-time Protocol Monitor';
          // Dynamic replace {SERVER} placeholder inside ban message field if still default
          const banMsgInput = document.querySelector('[data-key="banMessage"] input, input[name="banMessage"]');
          if (banMsgInput && banMsgInput.value && banMsgInput.value.includes('{SERVER}')) {
            banMsgInput.value = banMsgInput.value.replace('{SERVER}', d.server.name || 'EmpireRP');
          }
        }
        if (d.license) {
          document.getElementById('cardLicenseMasked').textContent = d.license.keyMasked || '••••';
          document.getElementById('cardLicenseStatus').textContent = d.license.status || '';
            document.getElementById('cardLicenseDays').textContent = (d.license.daysLeft || 0) + 'g';
          document.getElementById('cardLicenseExpiry').textContent = d.license.expiry || '';
        }
        document.getElementById('cardPlayersNow').textContent = d.playersOnline || (d.players ? d.players.length : 0) || 0;
        document.getElementById('cardPlayersSlots').textContent = (d.server && d.server.maxPlayers) ? ((d.playersOnline || 0) + ' / ' + d.server.maxPlayers) : '';
        const totalBans = d.totalBans || (Array.isArray(d.bans) ? d.bans.length : (d.bans ? Object.keys(d.bans).length : 0));
        document.getElementById('cardPlayersBanned').textContent = totalBans;
        document.getElementById('cardPlayersPeak').textContent = d.peakPlayers || 0;
        document.getElementById('cardPlayersAvg').textContent = d.averagePlayers || 0;
      }
      function updatePermissionVisibility(){
        if(typeof hasPerm!=='function') return;
        const mapping=[['btnKick','kick'],['btnBan','bans'],['btnScreenshot','logs'],['btnSpectate','search']];
        mapping.forEach(([id,perm])=>{ const el=document.getElementById(id); if(el) el.style.display = hasPerm(perm)?'flex':'none'; });
        const adminBtn=document.getElementById('btnAddAdmin'); if(adminBtn) adminBtn.style.display = hasPerm('manage_admins')?'inline-flex':'none';
      }
      window.addEventListener('message', function(event) {
        const data = event.data;
        if (!data || !data.type) return;
        if (data.type === 'show') {
          if (!data.data) { // apertura esplicita
            dashVisible = true;
            document.body.style.display = 'flex';
            applyDynamicCards();
            updatePermissionVisibility();
            return;
          }
          if (!dashVisible) return; // ignore push update if closed
          serverData = data.data;
          applyDynamicCards();
          updatePermissionVisibility();
          // Costruisci logs e consoleLogs a partire dalle violazioni e AI
          logs = [];
          consoleLogs = [];
          if (serverData.violations) {
            serverData.violations.forEach(v => {
              logs.push({
                time: v.created_at || v.time || new Date().toISOString(),
                type: v.violation_type || 'violazione',
                player: v.player_name || v.player || '-',
                details: v.description || v.violation_type || '-',
                member: v.identifier || '-'
              });
              const t = new Date(v.created_at || Date.now());
              const ts = t.toTimeString().substring(0, 8);
              consoleLogs.push(`[${ts}] VIOLAZIONE - ${v.player_name || '-'}: ${v.violation_type || ''}`);
            });
          }
          if (serverData.aiDetections) {
            serverData.aiDetections.forEach(d => {
              logs.push({
                time: d.created_at || d.time || new Date().toISOString(),
                type: 'ai_detection',
                player: d.player_name || '-',
                details: d.threat_type || d.detection_data || '-',
                member: d.identifier || '-'
              });
              const t = new Date(d.created_at || Date.now());
              const ts = t.toTimeString().substring(0, 8);
              consoleLogs.push(`[${ts}] AI - ${d.player_name || '-'}: ${d.threat_type || ''}`);
            });
          }
          // Aggiorna dashboard
          updateDashboardCards(); // mantiene logica legacy se ancora usata
          // Ridisegna sezioni
          renderPlayers();
          renderBans();
          renderAdmins();
          renderLogs();
          renderConsole();
          renderSearch();
          renderAnalysis();
          // Configurazione viene ridisegnata in base alla tab selezionata
          const activeTabBtn = document.querySelector('.config-tabs button.active');
          if (activeTabBtn) {
            renderConfigCategory(activeTabBtn.getAttribute('data-tab'));
          }
          // Multi stream
          renderMulti();
        } else if (data.type === 'hide') {
          dashVisible = false;
          document.body.style.display = 'none';
        }
        else if (data.type === 'logAppend') {
          // Append singolo log dinamico
          if (!logs) logs = [];
          logs.push(data.log);
          // Mantieni massimo 1000
          if (logs.length > 1000) logs.splice(0, logs.length - 1000);
          // Aggiungi anche a console se pertinente
          if (data.log) {
            const date = new Date(data.log.time || Date.now());
            const ts = date.toTimeString().substring(0,8);
            const label = getLogTypeLabel(data.log.type || 'log');
            consoleLogs.push(`[${ts}] ${label.text} - ${data.log.player || '-'}: ${data.log.details || ''}`);
            if (consoleLogs.length > 1500) consoleLogs.splice(0, consoleLogs.length - 1500);
          }
          // Se la sezione logs o console è visibile ridisegna solo quelle per prestazioni
          const activeSection = document.querySelector('.section.active');
            if (activeSection) {
              if (activeSection.id === 'logs') {
                renderLogs();
              } else if (activeSection.id === 'console') {
                renderConsole();
              }
            }
        }
      });
      // Inizializza Chart.js analisi e pulsanti periodo
      document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('analysisChart');
        if (canvas && typeof Chart !== 'undefined') {
          const ctx = canvas.getContext('2d');
          const makeGradient = (c1, c2) => { const g = ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,c1); g.addColorStop(1,c2); return g; };
          window.analysisChart = new Chart(ctx, {
            type:'line',
            data:{labels:[],datasets:[
              {label:'Giocatori',data:[],borderColor:'#3a81f6',borderWidth:2,pointRadius:0,fill:true,tension:0.35,backgroundColor:makeGradient('rgba(58,129,246,0.55)','rgba(58,129,246,0)')},
              {label:'Ban',data:[],borderColor:'#f7768e',borderWidth:1.5,pointRadius:0,fill:true,tension:0.35,backgroundColor:makeGradient('rgba(247,118,142,0.35)','rgba(247,118,142,0)')}
            ]},
            options:{
              animation:false,
              responsive:true,
              maintainAspectRatio:false,
              interaction:{mode:'index',intersect:false},
              plugins:{
                legend:{display:false},
                tooltip:{backgroundColor:'#11152a',borderColor:'#1e253f',borderWidth:1,displayColors:true,callbacks:{
                  title:items=>items[0].label,
                  label:ctx=>`${ctx.dataset.label}: ${ctx.formattedValue}`
                }}
              },
              scales:{
                x:{ticks:{color:'#546079',maxRotation:0,autoSkip:true},grid:{color:'rgba(255,255,255,0.04)',drawBorder:false}},
                y:{beginAtZero:true,ticks:{color:'#546079',precision:0},grid:{color:'rgba(255,255,255,0.04)',borderDash:[4,4],drawBorder:false}}
              }
            }
          });
          // Redraw gradient on resize
          new ResizeObserver(()=>{ if(!window.analysisChart)return; const g1=makeGradient('rgba(58,129,246,0.55)','rgba(58,129,246,0)'); const g2=makeGradient('rgba(247,118,142,0.35)','rgba(247,118,142,0)'); window.analysisChart.data.datasets[0].backgroundColor=g1; window.analysisChart.data.datasets[1].backgroundColor=g2; window.analysisChart.update('none'); }).observe(canvas);
        }
        document.querySelectorAll('.period-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            setAnalysisPeriod(btn.getAttribute('data-period'));
          })
        });
        const exportBtn = document.getElementById('exportSamples');
        if (exportBtn) exportBtn.addEventListener('click', exportSamplesCSV);
      });
      // ESC per chiudere
      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape'){
          fetch('https://' + GetParentResourceName() + '/close', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})});
        }
      })
      document.getElementById('closeDashboard').addEventListener('click', function(){
        fetch('https://' + GetParentResourceName() + '/close', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})});
      });
    </script>
  </body>
</html>